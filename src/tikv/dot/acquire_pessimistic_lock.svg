<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.47.1 (20210417.1919)
 -->
<!-- Title: tikv_acquire_pessimistic_lock Pages: 1 -->
<svg width="1366pt" height="999pt"
 viewBox="0.00 0.00 1366.00 999.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 995)">
<title>tikv_acquire_pessimistic_lock</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-995 1362,-995 1362,4 -4,4"/>
<g id="clust3" class="cluster">
<title>cluster_checklock</title>
<path fill="none" stroke="slategrey" stroke-dasharray="5,2" d="M688,-604C688,-604 1139,-604 1139,-604 1145,-604 1151,-610 1151,-616 1151,-616 1151,-971 1151,-971 1151,-977 1145,-983 1139,-983 1139,-983 688,-983 688,-983 682,-983 676,-977 676,-971 676,-971 676,-616 676,-616 676,-610 682,-604 688,-604"/>
<text text-anchor="middle" x="913.5" y="-963" font-family="Times,serif" font-size="20.00">检查lock</text>
</g>
<g id="clust5" class="cluster">
<title>cluster_check_write</title>
<path fill="none" stroke="slategrey" stroke-dasharray="5,2" d="M689,-8C689,-8 1161,-8 1161,-8 1167,-8 1173,-14 1173,-20 1173,-20 1173,-488 1173,-488 1173,-494 1167,-500 1161,-500 1161,-500 689,-500 689,-500 683,-500 677,-494 677,-488 677,-488 677,-20 677,-20 677,-14 683,-8 689,-8"/>
<text text-anchor="start" x="854" y="-480" font-family="Times,serif" font-size="20.00">检查是否有更新</text>
<text text-anchor="middle" x="925" y="-458" font-family="Times,serif" font-size="20.00"> 的写入版本</text>
</g>
<!-- AcquirePessimisticLock -->
<g id="node1" class="node">
<title>AcquirePessimisticLock</title>
<path fill="none" stroke="#1c2123" d="M12,-405C12,-405 215,-405 215,-405 221,-405 227,-411 227,-417 227,-417 227,-623 227,-623 227,-629 221,-635 215,-635 215,-635 12,-635 12,-635 6,-635 0,-629 0,-623 0,-623 0,-417 0,-417 0,-411 6,-405 12,-405"/>
<text text-anchor="middle" x="113.5" y="-619.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">AcquirePessimisticLock</text>
<polyline fill="none" stroke="#1c2123" points="0,-612 227,-612 "/>
<text text-anchor="start" x="8" y="-596.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">keys: Vec&lt;(Key, bool)&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="0,-589 227,-589 "/>
<text text-anchor="start" x="8" y="-573.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">primary: Vec&lt;u8&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="0,-566 227,-566 "/>
<text text-anchor="start" x="8" y="-550.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">start_ts: TimeStamp,</text>
<polyline fill="none" stroke="#1c2123" points="0,-543 227,-543 "/>
<text text-anchor="start" x="8" y="-527.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">lock_ttl: u64,</text>
<polyline fill="none" stroke="#1c2123" points="0,-520 227,-520 "/>
<text text-anchor="start" x="8" y="-504.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">is_first_lock: bool,</text>
<polyline fill="none" stroke="#1c2123" points="0,-497 227,-497 "/>
<text text-anchor="start" x="8" y="-481.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">for_update_ts: TimeStamp,</text>
<polyline fill="none" stroke="#1c2123" points="0,-474 227,-474 "/>
<text text-anchor="start" x="8" y="-458.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">wait_timeout: Option&lt;WaitTimeout&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="0,-451 227,-451 "/>
<text text-anchor="start" x="8" y="-435.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">return_values: bool,</text>
<polyline fill="none" stroke="#1c2123" points="0,-428 227,-428 "/>
<text text-anchor="start" x="8" y="-412.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">min_commit_ts: TimeStamp,</text>
</g>
<!-- process_write -->
<g id="node2" class="node">
<title>process_write</title>
<path fill="none" stroke="#1c2123" d="M275,-482C275,-482 409,-482 409,-482 415,-482 421,-488 421,-494 421,-494 421,-546 421,-546 421,-552 415,-558 409,-558 409,-558 275,-558 275,-558 269,-558 263,-552 263,-546 263,-546 263,-494 263,-494 263,-488 269,-482 275,-482"/>
<text text-anchor="middle" x="342" y="-542.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">process_write</text>
<polyline fill="none" stroke="#1c2123" points="263,-535 421,-535 "/>
<text text-anchor="start" x="271" y="-519.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">遍历所有的keys</text>
<text text-anchor="start" x="271" y="-504.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 对于每一个key调用</text>
<text text-anchor="start" x="271" y="-489.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> acquire_pessimistic_lock</text>
</g>
<!-- AcquirePessimisticLock&#45;&gt;process_write -->
<g id="edge1" class="edge">
<title>AcquirePessimisticLock&#45;&gt;process_write</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M227.09,-520C235.69,-520 244.3,-520 252.71,-520"/>
<polygon fill="green" stroke="green" points="252.87,-523.5 262.87,-520 252.87,-516.5 252.87,-523.5"/>
</g>
<!-- acquire_pessimistic_lock -->
<g id="node3" class="node">
<title>acquire_pessimistic_lock</title>
<path fill="none" stroke="#1c2123" d="M615,-576C615,-576 485,-576 485,-576 479,-576 473,-570 473,-564 473,-564 473,-552 473,-552 473,-546 479,-540 485,-540 485,-540 615,-540 615,-540 621,-540 627,-546 627,-552 627,-552 627,-564 627,-564 627,-570 621,-576 615,-576"/>
<text text-anchor="middle" x="550" y="-554.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">acquire_pessimistic_lock</text>
</g>
<!-- process_write&#45;&gt;acquire_pessimistic_lock -->
<g id="edge2" class="edge">
<title>process_write&#45;&gt;acquire_pessimistic_lock</title>
<path fill="none" stroke="#666666" d="M421.17,-534.42C434.82,-536.94 449.09,-539.57 462.93,-542.12"/>
<polygon fill="#666666" stroke="#666666" points="462.45,-545.59 472.92,-543.97 463.72,-538.71 462.45,-545.59"/>
</g>
<!-- update_max_ts -->
<g id="node4" class="node">
<title>update_max_ts</title>
<path fill="none" stroke="#1c2123" d="M469,-445C469,-445 631,-445 631,-445 637,-445 643,-451 643,-457 643,-457 643,-509 643,-509 643,-515 637,-521 631,-521 631,-521 469,-521 469,-521 463,-521 457,-515 457,-509 457,-509 457,-457 457,-457 457,-451 463,-445 469,-445"/>
<text text-anchor="middle" x="550" y="-505.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">update_max_ts</text>
<polyline fill="none" stroke="#1c2123" points="457,-498 643,-498 "/>
<text text-anchor="start" x="465" y="-482.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">使用for_update_ts更新</text>
<text text-anchor="start" x="465" y="-467.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> ConcurrencyManager::max_ts</text>
<text text-anchor="middle" x="550" y="-452.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 这个max_ts的作用是啥？</text>
</g>
<!-- process_write&#45;&gt;update_max_ts -->
<g id="edge3" class="edge">
<title>process_write&#45;&gt;update_max_ts</title>
<path fill="none" stroke="#666666" d="M421.17,-505.96C429.52,-504.46 438.09,-502.92 446.66,-501.38"/>
<polygon fill="#666666" stroke="#666666" points="447.48,-504.79 456.71,-499.58 446.24,-497.9 447.48,-504.79"/>
</g>
<!-- reader_load_lock -->
<g id="node5" class="node">
<title>reader_load_lock</title>
<path fill="none" stroke="#1c2123" d="M696,-719.5C696,-719.5 826,-719.5 826,-719.5 832,-719.5 838,-725.5 838,-731.5 838,-731.5 838,-798.5 838,-798.5 838,-804.5 832,-810.5 826,-810.5 826,-810.5 696,-810.5 696,-810.5 690,-810.5 684,-804.5 684,-798.5 684,-798.5 684,-731.5 684,-731.5 684,-725.5 690,-719.5 696,-719.5"/>
<text text-anchor="middle" x="761" y="-795.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">MvccReader::load_lock</text>
<polyline fill="none" stroke="#1c2123" points="684,-787.5 838,-787.5 "/>
<text text-anchor="start" x="692" y="-772.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">读取lock</text>
<text text-anchor="start" x="692" y="-757.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 然后检查lock的start_ts</text>
<text text-anchor="start" x="692" y="-742.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> lock_type</text>
<text text-anchor="start" x="692" y="-727.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> for_update_ts</text>
</g>
<!-- acquire_pessimistic_lock&#45;&gt;reader_load_lock -->
<g id="edge4" class="edge">
<title>acquire_pessimistic_lock&#45;&gt;reader_load_lock</title>
<path fill="none" stroke="#666666" d="M569.18,-576.01C599.47,-606.01 661.4,-667.34 706.51,-712.02"/>
<polygon fill="#666666" stroke="#666666" points="704.31,-714.77 713.88,-719.32 709.24,-709.8 704.31,-714.77"/>
</g>
<!-- put_lock_update -->
<g id="node6" class="node">
<title>put_lock_update</title>
<path fill="none" stroke="#1c2123" d="M1213,-701C1213,-701 1346,-701 1346,-701 1352,-701 1358,-707 1358,-713 1358,-713 1358,-735 1358,-735 1358,-741 1352,-747 1346,-747 1346,-747 1213,-747 1213,-747 1207,-747 1201,-741 1201,-735 1201,-735 1201,-713 1201,-713 1201,-707 1207,-701 1213,-701"/>
<text text-anchor="middle" x="1279.5" y="-731.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">put_lock</text>
<polyline fill="none" stroke="#1c2123" points="1201,-724 1358,-724 "/>
<text text-anchor="start" x="1209" y="-708.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">更新lock的for_update_ts</text>
</g>
<!-- acquire_pessimistic_lock&#45;&gt;put_lock_update -->
<g id="edge5" class="edge">
<title>acquire_pessimistic_lock&#45;&gt;put_lock_update</title>
<path fill="none" stroke="#666666" d="M627.06,-562.37C790.4,-571.84 1160.96,-593.93 1173,-600 1212.81,-620.05 1243.6,-662.45 1261.38,-692.05"/>
<polygon fill="#666666" stroke="#666666" points="1258.42,-693.92 1266.48,-700.79 1264.47,-690.39 1258.42,-693.92"/>
</g>
<!-- put_lock_new -->
<g id="node7" class="node">
<title>put_lock_new</title>
<path fill="none" stroke="#1c2123" d="M691,-509C691,-509 831,-509 831,-509 837,-509 843,-515 843,-521 843,-521 843,-543 843,-543 843,-549 837,-555 831,-555 831,-555 691,-555 691,-555 685,-555 679,-549 679,-543 679,-543 679,-521 679,-521 679,-515 685,-509 691,-509"/>
<text text-anchor="middle" x="761" y="-539.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">put_lock</text>
<polyline fill="none" stroke="#1c2123" points="679,-532 843,-532 "/>
<text text-anchor="middle" x="761" y="-516.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">当前请求key加上悲观锁</text>
</g>
<!-- acquire_pessimistic_lock&#45;&gt;put_lock_new -->
<g id="edge6" class="edge">
<title>acquire_pessimistic_lock&#45;&gt;put_lock_new</title>
<path fill="none" stroke="#666666" d="M627.05,-548.54C640.57,-546.86 654.78,-545.09 668.68,-543.36"/>
<polygon fill="#666666" stroke="#666666" points="669.24,-546.82 678.73,-542.11 668.37,-539.87 669.24,-546.82"/>
</g>
<!-- seek_write -->
<g id="node8" class="node">
<title>seek_write</title>
<path fill="none" stroke="#1c2123" d="M697,-260C697,-260 825,-260 825,-260 831,-260 837,-266 837,-272 837,-272 837,-294 837,-294 837,-300 831,-306 825,-306 825,-306 697,-306 697,-306 691,-306 685,-300 685,-294 685,-294 685,-272 685,-272 685,-266 691,-260 697,-260"/>
<text text-anchor="middle" x="761" y="-290.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">MvccReader::seek_write</text>
<polyline fill="none" stroke="#1c2123" points="685,-283 837,-283 "/>
<text text-anchor="start" x="693" y="-267.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">读取commit记录</text>
</g>
<!-- acquire_pessimistic_lock&#45;&gt;seek_write -->
<g id="edge7" class="edge">
<title>acquire_pessimistic_lock&#45;&gt;seek_write</title>
<path fill="none" stroke="#666666" d="M627.06,-541.55C632.79,-538.6 638.19,-535.11 643,-531 709.98,-473.7 741.27,-369.55 753.47,-316.3"/>
<polygon fill="#666666" stroke="#666666" points="756.92,-316.88 755.66,-306.36 750.09,-315.37 756.92,-316.88"/>
</g>
<!-- ErrorInner_KeyIsLocked -->
<g id="node9" class="node">
<title>ErrorInner_KeyIsLocked</title>
<path fill="none" stroke="#1c2123" d="M948,-613C948,-613 1096,-613 1096,-613 1102,-613 1108,-619 1108,-625 1108,-625 1108,-677 1108,-677 1108,-683 1102,-689 1096,-689 1096,-689 948,-689 948,-689 942,-689 936,-683 936,-677 936,-677 936,-625 936,-625 936,-619 942,-613 948,-613"/>
<text text-anchor="middle" x="1022" y="-673.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">ErrorInner::KeyIsLocked</text>
<polyline fill="none" stroke="#1c2123" points="936,-666 1108,-666 "/>
<text text-anchor="start" x="944" y="-650.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">lock.ts != reader.start_ts</text>
<text text-anchor="start" x="944" y="-635.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 不是当前同一事务的lock</text>
<text text-anchor="start" x="944" y="-620.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 返回KeyIsLocked Error</text>
</g>
<!-- reader_load_lock&#45;&gt;ErrorInner_KeyIsLocked -->
<g id="edge8" class="edge">
<title>reader_load_lock&#45;&gt;ErrorInner_KeyIsLocked</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M838.04,-719.41C851.46,-712.14 865.48,-705.04 879,-699 893.96,-692.32 910.14,-686.03 926.05,-680.33"/>
<polygon fill="green" stroke="green" points="927.63,-683.49 935.9,-676.87 925.31,-676.88 927.63,-683.49"/>
</g>
<!-- ErrorInner_LockTypeNotMatch -->
<g id="node10" class="node">
<title>ErrorInner_LockTypeNotMatch</title>
<path fill="none" stroke="#1c2123" d="M913,-708C913,-708 1131,-708 1131,-708 1137,-708 1143,-714 1143,-720 1143,-720 1143,-810 1143,-810 1143,-816 1137,-822 1131,-822 1131,-822 913,-822 913,-822 907,-822 901,-816 901,-810 901,-810 901,-720 901,-720 901,-714 907,-708 913,-708"/>
<text text-anchor="middle" x="1022" y="-806.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">ErrorInner::LockTypeNotMatch</text>
<polyline fill="none" stroke="#1c2123" points="901,-799 1143,-799 "/>
<text text-anchor="start" x="909" y="-783.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">lock.lock_type != LockType::Pessimistic</text>
<text text-anchor="start" x="909" y="-768.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 锁的类型不是悲观锁</text>
<text text-anchor="start" x="909" y="-753.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 返回锁类型不匹配</text>
<polyline fill="none" stroke="#1c2123" points="901,-746 1143,-746 "/>
<text text-anchor="start" x="909" y="-730.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">意味该请求已超时</text>
<text text-anchor="start" x="909" y="-715.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 什么情况会这种情况?</text>
</g>
<!-- reader_load_lock&#45;&gt;ErrorInner_LockTypeNotMatch -->
<g id="edge9" class="edge">
<title>reader_load_lock&#45;&gt;ErrorInner_LockTypeNotMatch</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M838.31,-765C854.65,-765 872.36,-765 890.1,-765"/>
<polygon fill="green" stroke="green" points="890.54,-768.5 900.54,-765 890.54,-761.5 890.54,-768.5"/>
</g>
<!-- update_for_udpate_ts -->
<g id="node11" class="node">
<title>update_for_udpate_ts</title>
<path fill="none" stroke="#1c2123" d="M930,-841C930,-841 1114,-841 1114,-841 1120,-841 1126,-847 1126,-853 1126,-853 1126,-875 1126,-875 1126,-881 1120,-887 1114,-887 1114,-887 930,-887 930,-887 924,-887 918,-881 918,-875 918,-875 918,-853 918,-853 918,-847 924,-841 930,-841"/>
<text text-anchor="start" x="926" y="-871.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">for_update_ts &gt; lock.for_update_ts</text>
<polyline fill="none" stroke="#1c2123" points="918,-864 1126,-864 "/>
<text text-anchor="start" x="926" y="-848.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">更新lock的for_update_ts</text>
</g>
<!-- reader_load_lock&#45;&gt;update_for_udpate_ts -->
<g id="edge10" class="edge">
<title>reader_load_lock&#45;&gt;update_for_udpate_ts</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M833.99,-810.65C848.51,-818.58 863.95,-826.15 879,-832 888.37,-835.64 898.26,-838.93 908.28,-841.88"/>
<polygon fill="green" stroke="green" points="907.33,-845.25 917.91,-844.6 909.24,-838.51 907.33,-845.25"/>
</g>
<!-- other_case_dup_lock -->
<g id="node12" class="node">
<title>other_case_dup_lock</title>
<path fill="none" stroke="#1c2123" d="M961.5,-906C961.5,-906 1082.5,-906 1082.5,-906 1088.5,-906 1094.5,-912 1094.5,-918 1094.5,-918 1094.5,-932 1094.5,-932 1094.5,-938 1088.5,-944 1082.5,-944 1082.5,-944 961.5,-944 961.5,-944 955.5,-944 949.5,-938 949.5,-932 949.5,-932 949.5,-918 949.5,-918 949.5,-912 955.5,-906 961.5,-906"/>
<text text-anchor="start" x="957.5" y="-928.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">其他情况为重复请求</text>
<text text-anchor="start" x="957.5" y="-913.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 直接返回OK</text>
</g>
<!-- reader_load_lock&#45;&gt;other_case_dup_lock -->
<g id="edge11" class="edge">
<title>reader_load_lock&#45;&gt;other_case_dup_lock</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M790.74,-810.53C811.65,-839.81 842.59,-876.15 879,-897 897.18,-907.41 918.57,-914.01 939.16,-918.18"/>
<polygon fill="green" stroke="green" points="938.72,-921.65 949.19,-920.03 939.99,-914.77 938.72,-921.65"/>
</g>
<!-- ErrorInner_WriteConflict -->
<g id="node13" class="node">
<title>ErrorInner_WriteConflict</title>
<path fill="none" stroke="#1c2123" d="M937.5,-16.5C937.5,-16.5 1106.5,-16.5 1106.5,-16.5 1112.5,-16.5 1118.5,-22.5 1118.5,-28.5 1118.5,-28.5 1118.5,-95.5 1118.5,-95.5 1118.5,-101.5 1112.5,-107.5 1106.5,-107.5 1106.5,-107.5 937.5,-107.5 937.5,-107.5 931.5,-107.5 925.5,-101.5 925.5,-95.5 925.5,-95.5 925.5,-28.5 925.5,-28.5 925.5,-22.5 931.5,-16.5 937.5,-16.5"/>
<text text-anchor="middle" x="1022" y="-92.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">ErrorInner::WriteConflict</text>
<polyline fill="none" stroke="#1c2123" points="925.5,-84.5 1118.5,-84.5 "/>
<text text-anchor="start" x="933.5" y="-69.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">commit_ts &gt; for_update_ts</text>
<text text-anchor="start" x="933.5" y="-54.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 已提交的commit_ts比当前的</text>
<text text-anchor="start" x="933.5" y="-39.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> for_update_ts 更新</text>
<text text-anchor="start" x="933.5" y="-24.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 存在写冲突</text>
</g>
<!-- seek_write&#45;&gt;ErrorInner_WriteConflict -->
<g id="edge13" class="edge">
<title>seek_write&#45;&gt;ErrorInner_WriteConflict</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M772.71,-259.89C790.21,-224.48 828.15,-156.72 879,-117 890.17,-108.27 902.89,-100.79 916.03,-94.41"/>
<polygon fill="green" stroke="green" points="917.57,-97.55 925.17,-90.17 914.63,-91.2 917.57,-97.55"/>
</g>
<!-- ErrorInner_PessimisticLockRolledBack -->
<g id="node14" class="node">
<title>ErrorInner_PessimisticLockRolledBack</title>
<path fill="none" stroke="#1c2123" d="M917,-127C917,-127 1127,-127 1127,-127 1133,-127 1139,-133 1139,-139 1139,-139 1139,-191 1139,-191 1139,-197 1133,-203 1127,-203 1127,-203 917,-203 917,-203 911,-203 905,-197 905,-191 905,-191 905,-139 905,-139 905,-133 911,-127 917,-127"/>
<text text-anchor="middle" x="1022" y="-187.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">ErrorInner::PessimisticLockRolledBack</text>
<polyline fill="none" stroke="#1c2123" points="905,-180 1139,-180 "/>
<text text-anchor="start" x="913" y="-164.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">commit_ts == reader.start_ts</text>
<text text-anchor="start" x="913" y="-149.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 且数据是当前事务的Rollback记录</text>
<text text-anchor="start" x="913" y="-134.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 返回PessimisticLockRollbacked错误</text>
</g>
<!-- seek_write&#45;&gt;ErrorInner_PessimisticLockRolledBack -->
<g id="edge14" class="edge">
<title>seek_write&#45;&gt;ErrorInner_PessimisticLockRolledBack</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M796.26,-259.85C819.04,-245.13 849.99,-226.4 879,-213 884.3,-210.55 889.76,-208.17 895.31,-205.85"/>
<polygon fill="green" stroke="green" points="896.78,-209.03 904.72,-202.02 894.14,-202.55 896.78,-209.03"/>
</g>
<!-- ErrorInner_PessimisticLockRolledBack2 -->
<g id="node15" class="node">
<title>ErrorInner_PessimisticLockRolledBack2</title>
<path fill="none" stroke="#1c2123" d="M891,-222.5C891,-222.5 1153,-222.5 1153,-222.5 1159,-222.5 1165,-228.5 1165,-234.5 1165,-234.5 1165,-331.5 1165,-331.5 1165,-337.5 1159,-343.5 1153,-343.5 1153,-343.5 891,-343.5 891,-343.5 885,-343.5 879,-337.5 879,-331.5 879,-331.5 879,-234.5 879,-234.5 879,-228.5 885,-222.5 891,-222.5"/>
<text text-anchor="middle" x="1022" y="-328.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">ErrorInner::PessimisticLockRolledBack</text>
<polyline fill="none" stroke="#1c2123" points="879,-320.5 1165,-320.5 "/>
<text text-anchor="start" x="887" y="-305.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">commit_ts &gt; reader.start_ts</text>
<text text-anchor="start" x="887" y="-290.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> commit_ts 比当前事务的 start_ts 更新，</text>
<text text-anchor="start" x="887" y="-275.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 说明在当前事务 begin 后有其他事务提交过</text>
<text text-anchor="start" x="887" y="-260.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 检查历史版本，如果发现当前请求的事务</text>
<text text-anchor="start" x="887" y="-245.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 有没有被 Rollback 过，返回 </text>
<text text-anchor="start" x="887" y="-230.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> PessimisticLockRollbacked 错误</text>
</g>
<!-- seek_write&#45;&gt;ErrorInner_PessimisticLockRolledBack2 -->
<g id="edge15" class="edge">
<title>seek_write&#45;&gt;ErrorInner_PessimisticLockRolledBack2</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M837.26,-283C847.22,-283 857.7,-283 868.4,-283"/>
<polygon fill="green" stroke="green" points="868.72,-286.5 878.72,-283 868.72,-279.5 868.72,-286.5"/>
</g>
<!-- check_data_constraint -->
<g id="node16" class="node">
<title>check_data_constraint</title>
<path fill="none" stroke="#1c2123" d="M923,-363C923,-363 1121,-363 1121,-363 1127,-363 1133,-369 1133,-375 1133,-375 1133,-427 1133,-427 1133,-433 1127,-439 1121,-439 1121,-439 923,-439 923,-439 917,-439 911,-433 911,-427 911,-427 911,-375 911,-375 911,-369 917,-363 923,-363"/>
<text text-anchor="middle" x="1022" y="-423.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">check_data_constraint</text>
<polyline fill="none" stroke="#1c2123" points="911,-416 1133,-416 "/>
<text text-anchor="start" x="919" y="-400.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">Checks the existence of the key</text>
<text text-anchor="start" x="919" y="-385.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> according to `should_not_exist`</text>
<text text-anchor="start" x="919" y="-370.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> if not, return an `AlreadyExist` Error</text>
</g>
<!-- seek_write&#45;&gt;check_data_constraint -->
<g id="edge16" class="edge">
<title>seek_write&#45;&gt;check_data_constraint</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M796.26,-306.15C819.04,-320.87 849.99,-339.6 879,-353 886.22,-356.33 893.75,-359.56 901.39,-362.65"/>
<polygon fill="green" stroke="green" points="900.19,-365.93 910.77,-366.35 902.76,-359.42 900.19,-365.93"/>
</g>
<!-- update_for_udpate_ts&#45;&gt;put_lock_update -->
<g id="edge12" class="edge">
<title>update_for_udpate_ts&#45;&gt;put_lock_update</title>
<path fill="none" stroke="#666666" d="M1126.35,-850.34C1142.55,-845.86 1158.66,-839.9 1173,-832 1207.03,-813.25 1237.03,-780 1256.25,-755.33"/>
<polygon fill="#666666" stroke="#666666" points="1259.07,-757.4 1262.34,-747.33 1253.5,-753.16 1259.07,-757.4"/>
</g>
</g>
</svg>
