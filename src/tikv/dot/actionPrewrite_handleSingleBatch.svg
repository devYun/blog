<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.47.1 (20210417.1919)
 -->
<!-- Title: handleSingleBatch Pages: 1 -->
<svg width="1469pt" height="437pt"
 viewBox="0.00 0.00 1469.00 436.50" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 432.5)">
<title>handleSingleBatch</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-432.5 1465,-432.5 1465,4 -4,4"/>
<!-- ttlManager_run -->
<g id="node1" class="node">
<title>ttlManager_run</title>
<path fill="none" stroke="#1c2123" d="M576,-299C576,-299 804,-299 804,-299 810,-299 816,-305 816,-311 816,-311 816,-416 816,-416 816,-422 810,-428 804,-428 804,-428 576,-428 576,-428 570,-428 564,-422 564,-416 564,-416 564,-311 564,-311 564,-305 570,-299 576,-299"/>
<text text-anchor="middle" x="690" y="-412.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">ttlManager</text>
<polyline fill="none" stroke="#1c2123" points="564,-405 816,-405 "/>
<text text-anchor="middle" x="690" y="-389.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">run</text>
<polyline fill="none" stroke="#1c2123" points="564,-382 816,-382 "/>
<text text-anchor="start" x="572" y="-366.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">prewrite成功</text>
<text text-anchor="start" x="572" y="-351.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 如果batch.isPrimary</text>
<text text-anchor="start" x="572" y="-336.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 且txn size &gt; 32M(TTLRefreshedTxnSize)</text>
<text text-anchor="start" x="572" y="-321.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 则调用ttlManager.run</text>
<text text-anchor="start" x="572" y="-306.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 定期发送TxnHeartBea心跳</text>
</g>
<!-- ttlManager_keepAlive -->
<g id="node2" class="node">
<title>ttlManager_keepAlive</title>
<path fill="none" stroke="#1c2123" d="M871,-321.5C871,-321.5 1006,-321.5 1006,-321.5 1012,-321.5 1018,-327.5 1018,-333.5 1018,-333.5 1018,-393.5 1018,-393.5 1018,-399.5 1012,-405.5 1006,-405.5 1006,-405.5 871,-405.5 871,-405.5 865,-405.5 859,-399.5 859,-393.5 859,-393.5 859,-333.5 859,-333.5 859,-327.5 865,-321.5 871,-321.5"/>
<text text-anchor="middle" x="938.5" y="-390.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">ttlManager</text>
<polyline fill="none" stroke="#1c2123" points="859,-382.5 1018,-382.5 "/>
<text text-anchor="middle" x="938.5" y="-367.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">keepAlive</text>
<polyline fill="none" stroke="#1c2123" points="859,-359.5 1018,-359.5 "/>
<text text-anchor="start" x="867" y="-344.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">每隔ManagedLockTTL/2</text>
<text text-anchor="start" x="867" y="-329.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 发送一次TxnHeartBeat</text>
</g>
<!-- ttlManager_run&#45;&gt;ttlManager_keepAlive -->
<g id="edge1" class="edge">
<title>ttlManager_run&#45;&gt;ttlManager_keepAlive</title>
<path fill="none" stroke="#666666" d="M816.06,-363.5C827.07,-363.5 838.07,-363.5 848.7,-363.5"/>
<polygon fill="#666666" stroke="#666666" points="848.76,-367 858.76,-363.5 848.76,-360 848.76,-367"/>
</g>
<!-- sendTxnHeartBeat -->
<g id="node3" class="node">
<title>sendTxnHeartBeat</title>
<path fill="none" stroke="#1c2123" d="M1073,-333C1073,-333 1276,-333 1276,-333 1282,-333 1288,-339 1288,-345 1288,-345 1288,-382 1288,-382 1288,-388 1282,-394 1276,-394 1276,-394 1073,-394 1073,-394 1067,-394 1061,-388 1061,-382 1061,-382 1061,-345 1061,-345 1061,-339 1067,-333 1073,-333"/>
<text text-anchor="middle" x="1174.5" y="-378.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">sendTxnHeartBeat</text>
<polyline fill="none" stroke="#1c2123" points="1061,-371 1288,-371 "/>
<text text-anchor="start" x="1069" y="-355.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">更新lock的ttl时间</text>
<text text-anchor="start" x="1069" y="-340.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> newttl = uptime + ManagedLockTTL</text>
</g>
<!-- ttlManager_keepAlive&#45;&gt;sendTxnHeartBeat -->
<g id="edge2" class="edge">
<title>ttlManager_keepAlive&#45;&gt;sendTxnHeartBeat</title>
<path fill="none" stroke="#666666" d="M1018.07,-363.5C1028.54,-363.5 1039.47,-363.5 1050.48,-363.5"/>
<polygon fill="#666666" stroke="#666666" points="1050.59,-367 1060.59,-363.5 1050.59,-360 1050.59,-367"/>
</g>
<!-- CmdTxnHeartBeat -->
<g id="node4" class="node">
<title>CmdTxnHeartBeat</title>
<path fill="none" stroke="#1c2123" d="M1336,-340.5C1336,-340.5 1449,-340.5 1449,-340.5 1455,-340.5 1461,-346.5 1461,-352.5 1461,-352.5 1461,-374.5 1461,-374.5 1461,-380.5 1455,-386.5 1449,-386.5 1449,-386.5 1336,-386.5 1336,-386.5 1330,-386.5 1324,-380.5 1324,-374.5 1324,-374.5 1324,-352.5 1324,-352.5 1324,-346.5 1330,-340.5 1336,-340.5"/>
<text text-anchor="middle" x="1392.5" y="-371.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">CmdTxnHeartBeat</text>
<polyline fill="none" stroke="#1c2123" points="1324,-363.5 1461,-363.5 "/>
<text text-anchor="start" x="1332" y="-348.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">更新primay lock的ttl</text>
</g>
<!-- sendTxnHeartBeat&#45;&gt;CmdTxnHeartBeat -->
<g id="edge3" class="edge">
<title>sendTxnHeartBeat&#45;&gt;CmdTxnHeartBeat</title>
<path fill="none" stroke="#666666" d="M1288.24,-363.5C1296.9,-363.5 1305.51,-363.5 1313.86,-363.5"/>
<polygon fill="#666666" stroke="#666666" points="1313.9,-367 1323.9,-363.5 1313.9,-360 1313.9,-367"/>
</g>
<!-- handleSingleBatch -->
<g id="node5" class="node">
<title>handleSingleBatch</title>
<path fill="none" stroke="#1c2123" d="M12,-218.5C12,-218.5 107,-218.5 107,-218.5 113,-218.5 119,-224.5 119,-230.5 119,-230.5 119,-252.5 119,-252.5 119,-258.5 113,-264.5 107,-264.5 107,-264.5 12,-264.5 12,-264.5 6,-264.5 0,-258.5 0,-252.5 0,-252.5 0,-230.5 0,-230.5 0,-224.5 6,-218.5 12,-218.5"/>
<text text-anchor="middle" x="59.5" y="-249.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">preWriteAction</text>
<polyline fill="none" stroke="#1c2123" points="0,-241.5 119,-241.5 "/>
<text text-anchor="start" x="8" y="-226.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">handleSingleBatch</text>
</g>
<!-- handleSingleBatch&#45;&gt;ttlManager_run -->
<g id="edge6" class="edge">
<title>handleSingleBatch&#45;&gt;ttlManager_run</title>
<path fill="none" stroke="#666666" d="M107.75,-264.62C122.6,-271.17 139.24,-277.79 155,-282.5 287.43,-322.08 444.39,-342.94 553.73,-353.51"/>
<polygon fill="#666666" stroke="#666666" points="553.54,-357 563.83,-354.47 554.2,-350.04 553.54,-357"/>
</g>
<!-- buildPrewriteRequest -->
<g id="node6" class="node">
<title>buildPrewriteRequest</title>
<path fill="none" stroke="#1c2123" d="M167,-136.5C167,-136.5 361,-136.5 361,-136.5 367,-136.5 373,-142.5 373,-148.5 373,-148.5 373,-200.5 373,-200.5 373,-206.5 367,-212.5 361,-212.5 361,-212.5 167,-212.5 167,-212.5 161,-212.5 155,-206.5 155,-200.5 155,-200.5 155,-148.5 155,-148.5 155,-142.5 161,-136.5 167,-136.5"/>
<text text-anchor="middle" x="264" y="-197.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">buildPrewriteRequest</text>
<polyline fill="none" stroke="#1c2123" points="155,-189.5 373,-189.5 "/>
<text text-anchor="start" x="163" y="-174.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">将batch mutations 复制到request中</text>
<text text-anchor="start" x="163" y="-159.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 并选择mutations[0]的key</text>
<text text-anchor="start" x="163" y="-144.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 作为primary key</text>
</g>
<!-- handleSingleBatch&#45;&gt;buildPrewriteRequest -->
<g id="edge7" class="edge">
<title>handleSingleBatch&#45;&gt;buildPrewriteRequest</title>
<path fill="none" stroke="#666666" d="M119.07,-222.12C127.48,-219.34 136.37,-216.4 145.44,-213.4"/>
<polygon fill="#666666" stroke="#666666" points="146.55,-216.72 154.94,-210.25 144.35,-210.07 146.55,-216.72"/>
</g>
<!-- SendReq -->
<g id="node9" class="node">
<title>SendReq</title>
<path fill="none" stroke="#1c2123" d="M421,-270.5C421,-270.5 516,-270.5 516,-270.5 522,-270.5 528,-276.5 528,-282.5 528,-282.5 528,-304.5 528,-304.5 528,-310.5 522,-316.5 516,-316.5 516,-316.5 421,-316.5 421,-316.5 415,-316.5 409,-310.5 409,-304.5 409,-304.5 409,-282.5 409,-282.5 409,-276.5 415,-270.5 421,-270.5"/>
<text text-anchor="middle" x="468.5" y="-301.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">SendReq</text>
<polyline fill="none" stroke="#1c2123" points="409,-293.5 528,-293.5 "/>
<text text-anchor="start" x="417" y="-278.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">发送请求到TiKV</text>
</g>
<!-- handleSingleBatch&#45;&gt;SendReq -->
<g id="edge8" class="edge">
<title>handleSingleBatch&#45;&gt;SendReq</title>
<path fill="none" stroke="#666666" d="M119.19,-250.44C131.04,-252.17 143.41,-253.94 155,-255.5 238.76,-266.79 335.36,-278.31 398.72,-285.66"/>
<polygon fill="#666666" stroke="#666666" points="398.65,-289.17 408.98,-286.85 399.45,-282.22 398.65,-289.17"/>
</g>
<!-- resolveLocksForWrite -->
<g id="node10" class="node">
<title>resolveLocksForWrite</title>
<path fill="none" stroke="#1c2123" d="M620,-203.5C620,-203.5 760,-203.5 760,-203.5 766,-203.5 772,-209.5 772,-215.5 772,-215.5 772,-267.5 772,-267.5 772,-273.5 766,-279.5 760,-279.5 760,-279.5 620,-279.5 620,-279.5 614,-279.5 608,-273.5 608,-267.5 608,-267.5 608,-215.5 608,-215.5 608,-209.5 614,-203.5 620,-203.5"/>
<text text-anchor="middle" x="690" y="-264.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">resolveLocksForWrite</text>
<polyline fill="none" stroke="#1c2123" points="608,-256.5 772,-256.5 "/>
<text text-anchor="start" x="616" y="-241.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">prewrite报错</text>
<text text-anchor="start" x="616" y="-226.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 从err中抽出冲突的locks</text>
<text text-anchor="start" x="616" y="-211.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 尝试resolve这些locks</text>
</g>
<!-- handleSingleBatch&#45;&gt;resolveLocksForWrite -->
<g id="edge9" class="edge">
<title>handleSingleBatch&#45;&gt;resolveLocksForWrite</title>
<path fill="none" stroke="#666666" d="M119.06,-241.5C228.95,-241.5 466.77,-241.5 597.8,-241.5"/>
<polygon fill="#666666" stroke="#666666" points="597.82,-245 607.82,-241.5 597.82,-238 597.82,-245"/>
</g>
<!-- minCommitTS -->
<g id="node11" class="node">
<title>minCommitTS</title>
<path fill="none" stroke="#1c2123" d="M302,-117.5C302,-117.5 226,-117.5 226,-117.5 220,-117.5 214,-111.5 214,-105.5 214,-105.5 214,-93.5 214,-93.5 214,-87.5 220,-81.5 226,-81.5 226,-81.5 302,-81.5 302,-81.5 308,-81.5 314,-87.5 314,-93.5 314,-93.5 314,-105.5 314,-105.5 314,-111.5 308,-117.5 302,-117.5"/>
<text text-anchor="middle" x="264" y="-95.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">minCommitTS</text>
</g>
<!-- handleSingleBatch&#45;&gt;minCommitTS -->
<g id="edge10" class="edge">
<title>handleSingleBatch&#45;&gt;minCommitTS</title>
<path fill="none" stroke="#666666" d="M73.32,-218.3C89.08,-191.98 118.31,-149.71 155,-126.5 169.54,-117.3 187.03,-111.24 203.66,-107.24"/>
<polygon fill="#666666" stroke="#666666" points="204.84,-110.56 213.86,-105 203.35,-103.72 204.84,-110.56"/>
</g>
<!-- Mutation -->
<g id="node7" class="node">
<title>Mutation</title>
<path fill="none" stroke="#1c2123" d="M439,-83.5C439,-83.5 498,-83.5 498,-83.5 504,-83.5 510,-89.5 510,-95.5 510,-95.5 510,-163.5 510,-163.5 510,-169.5 504,-175.5 498,-175.5 498,-175.5 439,-175.5 439,-175.5 433,-175.5 427,-169.5 427,-163.5 427,-163.5 427,-95.5 427,-95.5 427,-89.5 433,-83.5 439,-83.5"/>
<text text-anchor="middle" x="468.5" y="-160.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Mutation</text>
<polyline fill="none" stroke="#1c2123" points="427,-152.5 510,-152.5 "/>
<text text-anchor="start" x="435" y="-137.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Op Op</text>
<polyline fill="none" stroke="#1c2123" points="427,-129.5 510,-129.5 "/>
<text text-anchor="start" x="435" y="-114.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Key []byte</text>
<polyline fill="none" stroke="#1c2123" points="427,-106.5 510,-106.5 "/>
<text text-anchor="start" x="435" y="-91.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Value []byte</text>
</g>
<!-- buildPrewriteRequest&#45;&gt;Mutation -->
<g id="edge4" class="edge">
<title>buildPrewriteRequest&#45;&gt;Mutation</title>
<path fill="none" stroke="#666666" d="M373.07,-150.48C388.39,-147.08 403.5,-143.72 416.99,-140.72"/>
<polygon fill="#666666" stroke="#666666" points="417.97,-144.09 426.97,-138.51 416.45,-137.26 417.97,-144.09"/>
</g>
<!-- buildPrewriteRequest&#45;&gt;SendReq -->
<g id="edge13" class="edge">
<title>buildPrewriteRequest&#45;&gt;SendReq</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M329.91,-212.64C359.01,-229.75 392.73,-249.56 419.5,-265.3"/>
<polygon fill="green" stroke="green" points="417.91,-268.42 428.3,-270.47 421.45,-262.38 417.91,-268.42"/>
</g>
<!-- Op -->
<g id="node8" class="node">
<title>Op</title>
<path fill="none" stroke="#1c2123" d="M616,-0.5C616,-0.5 764,-0.5 764,-0.5 770,-0.5 776,-6.5 776,-12.5 776,-12.5 776,-172.5 776,-172.5 776,-178.5 770,-184.5 764,-184.5 764,-184.5 616,-184.5 616,-184.5 610,-184.5 604,-178.5 604,-172.5 604,-172.5 604,-12.5 604,-12.5 604,-6.5 610,-0.5 616,-0.5"/>
<text text-anchor="middle" x="690" y="-169.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Op</text>
<polyline fill="none" stroke="#1c2123" points="604,-161.5 776,-161.5 "/>
<text text-anchor="start" x="612" y="-146.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Op_Put Op = 0</text>
<polyline fill="none" stroke="#1c2123" points="604,-138.5 776,-138.5 "/>
<text text-anchor="start" x="612" y="-123.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Op_Del Op = 1</text>
<polyline fill="none" stroke="#1c2123" points="604,-115.5 776,-115.5 "/>
<text text-anchor="start" x="612" y="-100.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Op_Lock Op = 2</text>
<polyline fill="none" stroke="#1c2123" points="604,-92.5 776,-92.5 "/>
<text text-anchor="start" x="612" y="-77.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Op_Rollback Op = 3</text>
<polyline fill="none" stroke="#1c2123" points="604,-69.5 776,-69.5 "/>
<text text-anchor="start" x="612" y="-54.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Op_Insert Op = 4</text>
<polyline fill="none" stroke="#1c2123" points="604,-46.5 776,-46.5 "/>
<text text-anchor="start" x="612" y="-31.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Op_PessimisticLock Op = 5</text>
<polyline fill="none" stroke="#1c2123" points="604,-23.5 776,-23.5 "/>
<text text-anchor="start" x="612" y="-8.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Op_CheckNotExists Op = 6</text>
</g>
<!-- Mutation&#45;&gt;Op -->
<g id="edge5" class="edge">
<title>Mutation&#45;&gt;Op</title>
<path fill="none" stroke="#666666" d="M510.02,-122.67C533.61,-118.69 564.42,-113.5 593.81,-108.55"/>
<polygon fill="#666666" stroke="#666666" points="594.43,-111.99 603.71,-106.88 593.27,-105.09 594.43,-111.99"/>
</g>
<!-- SendReq&#45;&gt;ttlManager_run -->
<g id="edge14" class="edge">
<title>SendReq&#45;&gt;ttlManager_run</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M528.03,-312.17C536.24,-314.78 544.94,-317.56 553.88,-320.41"/>
<polygon fill="green" stroke="green" points="553.07,-323.82 563.66,-323.53 555.19,-317.15 553.07,-323.82"/>
</g>
<!-- SendReq&#45;&gt;resolveLocksForWrite -->
<g id="edge15" class="edge">
<title>SendReq&#45;&gt;resolveLocksForWrite</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M528.03,-279.63C549.48,-274.55 574.29,-268.67 597.91,-263.08"/>
<polygon fill="green" stroke="green" points="599.03,-266.41 607.95,-260.7 597.41,-259.6 599.03,-266.41"/>
</g>
<!-- resolveLocks -->
<g id="node12" class="node">
<title>resolveLocks</title>
<path fill="none" stroke="#1c2123" d="M864,-211C864,-211 1013,-211 1013,-211 1019,-211 1025,-217 1025,-223 1025,-223 1025,-260 1025,-260 1025,-266 1019,-272 1013,-272 1013,-272 864,-272 864,-272 858,-272 852,-266 852,-260 852,-260 852,-223 852,-223 852,-217 858,-211 864,-211"/>
<text text-anchor="middle" x="938.5" y="-256.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">resolveLocks</text>
<polyline fill="none" stroke="#1c2123" points="852,-249 1025,-249 "/>
<text text-anchor="start" x="860" y="-233.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">遍历locks，对于每个Lock</text>
<text text-anchor="start" x="860" y="-218.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 调用resolve函数</text>
</g>
<!-- resolveLocksForWrite&#45;&gt;resolveLocks -->
<g id="edge11" class="edge">
<title>resolveLocksForWrite&#45;&gt;resolveLocks</title>
<path fill="none" stroke="#666666" d="M772.05,-241.5C794.3,-241.5 818.63,-241.5 841.63,-241.5"/>
<polygon fill="#666666" stroke="#666666" points="841.74,-245 851.74,-241.5 841.74,-238 841.74,-245"/>
</g>
<!-- resolve -->
<g id="node13" class="node">
<title>resolve</title>
<path fill="none" stroke="#1c2123" d="M1190.5,-259.5C1190.5,-259.5 1158.5,-259.5 1158.5,-259.5 1152.5,-259.5 1146.5,-253.5 1146.5,-247.5 1146.5,-247.5 1146.5,-235.5 1146.5,-235.5 1146.5,-229.5 1152.5,-223.5 1158.5,-223.5 1158.5,-223.5 1190.5,-223.5 1190.5,-223.5 1196.5,-223.5 1202.5,-229.5 1202.5,-235.5 1202.5,-235.5 1202.5,-247.5 1202.5,-247.5 1202.5,-253.5 1196.5,-259.5 1190.5,-259.5"/>
<text text-anchor="middle" x="1174.5" y="-237.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">resolve</text>
</g>
<!-- resolveLocks&#45;&gt;resolve -->
<g id="edge12" class="edge">
<title>resolveLocks&#45;&gt;resolve</title>
<path fill="none" stroke="#666666" d="M1025.3,-241.5C1063.41,-241.5 1106.27,-241.5 1136.06,-241.5"/>
<polygon fill="#666666" stroke="#666666" points="1136.41,-245 1146.41,-241.5 1136.41,-238 1136.41,-245"/>
</g>
</g>
</svg>
