<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.47.1 (20210417.1919)
 -->
<!-- Title: for_update_ts Pages: 1 -->
<svg width="1759pt" height="582pt"
 viewBox="0.00 0.00 1759.00 582.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 578)">
<title>for_update_ts</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-578 1755,-578 1755,4 -4,4"/>
<g id="clust2" class="cluster">
<title>cluster_adapter</title>
<path fill="none" stroke="slategrey" stroke-dasharray="5,2" d="M776.5,-8C776.5,-8 947.5,-8 947.5,-8 953.5,-8 959.5,-14 959.5,-20 959.5,-20 959.5,-188 959.5,-188 959.5,-194 953.5,-200 947.5,-200 947.5,-200 776.5,-200 776.5,-200 770.5,-200 764.5,-194 764.5,-188 764.5,-188 764.5,-20 764.5,-20 764.5,-14 770.5,-8 776.5,-8"/>
<text text-anchor="middle" x="862" y="-180" font-family="Times,serif" font-size="20.00">executor/adapter.go</text>
</g>
<g id="clust3" class="cluster">
<title>cluster_executorBuilder</title>
<path fill="none" stroke="slategrey" stroke-dasharray="5,2" d="M20,-208C20,-208 995,-208 995,-208 1001,-208 1007,-214 1007,-220 1007,-220 1007,-554 1007,-554 1007,-560 1001,-566 995,-566 995,-566 20,-566 20,-566 14,-566 8,-560 8,-554 8,-554 8,-220 8,-220 8,-214 14,-208 20,-208"/>
<text text-anchor="middle" x="507.5" y="-546" font-family="Times,serif" font-size="20.00">executorBuilder</text>
</g>
<!-- TransactionContext -->
<g id="node1" class="node">
<title>TransactionContext</title>
<path fill="none" stroke="#1c2123" d="M1237,-58C1237,-58 1338,-58 1338,-58 1344,-58 1350,-64 1350,-70 1350,-70 1350,-138 1350,-138 1350,-144 1344,-150 1338,-150 1338,-150 1237,-150 1237,-150 1231,-150 1225,-144 1225,-138 1225,-138 1225,-70 1225,-70 1225,-64 1231,-58 1237,-58"/>
<text text-anchor="middle" x="1287.5" y="-134.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">TransactionContext</text>
<polyline fill="none" stroke="#1c2123" points="1225,-127 1350,-127 "/>
<text text-anchor="start" x="1233" y="-111.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">forUpdateTS uint64</text>
<polyline fill="none" stroke="#1c2123" points="1225,-104 1350,-104 "/>
<text text-anchor="start" x="1233" y="-88.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">StartTS uint64</text>
<polyline fill="none" stroke="#1c2123" points="1225,-81 1350,-81 "/>
<text text-anchor="middle" x="1287.5" y="-65.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">...</text>
</g>
<!-- newLockCtx -->
<g id="node3" class="node">
<title>newLockCtx</title>
<path fill="none" stroke="#1c2123" d="M1398,-73.5C1398,-73.5 1544,-73.5 1544,-73.5 1550,-73.5 1556,-79.5 1556,-85.5 1556,-85.5 1556,-122.5 1556,-122.5 1556,-128.5 1550,-134.5 1544,-134.5 1544,-134.5 1398,-134.5 1398,-134.5 1392,-134.5 1386,-128.5 1386,-122.5 1386,-122.5 1386,-85.5 1386,-85.5 1386,-79.5 1392,-73.5 1398,-73.5"/>
<text text-anchor="middle" x="1471" y="-119.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">newLockCtx</text>
<polyline fill="none" stroke="#1c2123" points="1386,-111.5 1556,-111.5 "/>
<text text-anchor="start" x="1394" y="-96.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">将TransactionContext的</text>
<text text-anchor="middle" x="1471" y="-81.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> forUpdateTS 传给LockCtx</text>
</g>
<!-- TransactionContext&#45;&gt;newLockCtx -->
<g id="edge1" class="edge">
<title>TransactionContext&#45;&gt;newLockCtx</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M1350.2,-104C1358.47,-104 1367.11,-104 1375.78,-104"/>
<polygon fill="green" stroke="green" points="1375.97,-107.5 1385.97,-104 1375.97,-100.5 1375.97,-107.5"/>
</g>
<!-- LockCtx -->
<g id="node2" class="node">
<title>LockCtx</title>
<path fill="none" stroke="#1c2123" d="M1604,-58C1604,-58 1739,-58 1739,-58 1745,-58 1751,-64 1751,-70 1751,-70 1751,-138 1751,-138 1751,-144 1745,-150 1739,-150 1739,-150 1604,-150 1604,-150 1598,-150 1592,-144 1592,-138 1592,-138 1592,-70 1592,-70 1592,-64 1598,-58 1604,-58"/>
<text text-anchor="middle" x="1671.5" y="-134.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">LockCtx</text>
<polyline fill="none" stroke="#1c2123" points="1592,-127 1751,-127 "/>
<text text-anchor="start" x="1600" y="-111.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">ForUpdateTS uint64</text>
<polyline fill="none" stroke="#1c2123" points="1592,-104 1751,-104 "/>
<text text-anchor="start" x="1600" y="-88.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">LockWaitTime int64</text>
<polyline fill="none" stroke="#1c2123" points="1592,-81 1751,-81 "/>
<text text-anchor="start" x="1600" y="-65.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">WaitStartTime time.Time</text>
</g>
<!-- newLockCtx&#45;&gt;LockCtx -->
<g id="edge2" class="edge">
<title>newLockCtx&#45;&gt;LockCtx</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M1556.18,-104C1564.6,-104 1573.16,-104 1581.62,-104"/>
<polygon fill="green" stroke="green" points="1581.87,-107.5 1591.87,-104 1581.87,-100.5 1581.87,-107.5"/>
</g>
<!-- UpdateForUpdateTS -->
<g id="node4" class="node">
<title>UpdateForUpdateTS</title>
<path fill="none" stroke="#1c2123" d="M784.5,-17C784.5,-17 939.5,-17 939.5,-17 945.5,-17 951.5,-23 951.5,-29 951.5,-29 951.5,-149 951.5,-149 951.5,-155 945.5,-161 939.5,-161 939.5,-161 784.5,-161 784.5,-161 778.5,-161 772.5,-155 772.5,-149 772.5,-149 772.5,-29 772.5,-29 772.5,-23 778.5,-17 784.5,-17"/>
<text text-anchor="middle" x="862" y="-145.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">UpdateForUpdateTS</text>
<polyline fill="none" stroke="#1c2123" points="772.5,-138 951.5,-138 "/>
<text text-anchor="start" x="780.5" y="-122.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">if newForUpdateTS == 0</text>
<text text-anchor="start" x="780.5" y="-107.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">Because the ForUpdateTS is </text>
<text text-anchor="start" x="780.5" y="-92.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> used for the snapshot for</text>
<text text-anchor="start" x="780.5" y="-77.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> reading data in DML.</text>
<polyline fill="none" stroke="#1c2123" points="772.5,-70 951.5,-70 "/>
<text text-anchor="start" x="780.5" y="-54.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">We can avoid allocating</text>
<text text-anchor="start" x="780.5" y="-39.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> a global TSO here to speed</text>
<text text-anchor="start" x="780.5" y="-24.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> it up by using the local TSO.</text>
</g>
<!-- SetForUpdateTS -->
<g id="node5" class="node">
<title>SetForUpdateTS</title>
<path fill="none" stroke="#1c2123" d="M1153.5,-134C1153.5,-134 1070.5,-134 1070.5,-134 1064.5,-134 1058.5,-128 1058.5,-122 1058.5,-122 1058.5,-110 1058.5,-110 1058.5,-104 1064.5,-98 1070.5,-98 1070.5,-98 1153.5,-98 1153.5,-98 1159.5,-98 1165.5,-104 1165.5,-110 1165.5,-110 1165.5,-122 1165.5,-122 1165.5,-128 1159.5,-134 1153.5,-134"/>
<text text-anchor="middle" x="1112" y="-112.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">SetForUpdateTS</text>
</g>
<!-- UpdateForUpdateTS&#45;&gt;SetForUpdateTS -->
<g id="edge3" class="edge">
<title>UpdateForUpdateTS&#45;&gt;SetForUpdateTS</title>
<path fill="none" stroke="#666666" d="M951.83,-98.67C983.79,-102.15 1019.13,-106 1048.39,-109.18"/>
<polygon fill="#666666" stroke="#666666" points="1048.14,-112.68 1058.46,-110.28 1048.9,-105.72 1048.14,-112.68"/>
</g>
<!-- GetStore_CurrentVersion -->
<g id="node6" class="node">
<title>GetStore_CurrentVersion</title>
<path fill="none" stroke="#1c2123" d="M1177,-80C1177,-80 1047,-80 1047,-80 1041,-80 1035,-74 1035,-68 1035,-68 1035,-56 1035,-56 1035,-50 1041,-44 1047,-44 1047,-44 1177,-44 1177,-44 1183,-44 1189,-50 1189,-56 1189,-56 1189,-68 1189,-68 1189,-74 1183,-80 1177,-80"/>
<text text-anchor="middle" x="1112" y="-58.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">GetStore_CurrentVersion</text>
</g>
<!-- UpdateForUpdateTS&#45;&gt;GetStore_CurrentVersion -->
<g id="edge5" class="edge">
<title>UpdateForUpdateTS&#45;&gt;GetStore_CurrentVersion</title>
<path fill="none" stroke="#666666" d="M951.83,-79.33C975.55,-76.75 1001.13,-73.96 1024.71,-71.39"/>
<polygon fill="#666666" stroke="#666666" points="1025.12,-74.87 1034.68,-70.31 1024.36,-67.91 1025.12,-74.87"/>
</g>
<!-- SetForUpdateTS&#45;&gt;TransactionContext -->
<g id="edge4" class="edge">
<title>SetForUpdateTS&#45;&gt;TransactionContext:forUpdateTS</title>
<path fill="none" stroke="#666666" d="M1165.7,-116C1181.21,-116 1198.43,-116 1214.88,-116"/>
<polygon fill="#666666" stroke="#666666" points="1215,-119.5 1225,-116 1215,-112.5 1215,-119.5"/>
</g>
<!-- refreshForUpdateTSForRC -->
<g id="node7" class="node">
<title>refreshForUpdateTSForRC</title>
<path fill="none" stroke="#1c2123" d="M677,-396C677,-396 537,-396 537,-396 531,-396 525,-390 525,-384 525,-384 525,-372 525,-372 525,-366 531,-360 537,-360 537,-360 677,-360 677,-360 683,-360 689,-366 689,-372 689,-372 689,-384 689,-384 689,-390 683,-396 677,-396"/>
<text text-anchor="middle" x="607" y="-374.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">refreshForUpdateTSForRC</text>
</g>
<!-- refreshForUpdateTSForRC&#45;&gt;UpdateForUpdateTS -->
<g id="edge6" class="edge">
<title>refreshForUpdateTSForRC&#45;&gt;UpdateForUpdateTS</title>
<path fill="none" stroke="#666666" d="M617.97,-359.8C636.54,-326.79 678.73,-255.66 725,-204 737.1,-190.49 750.79,-177.14 764.71,-164.58"/>
<polygon fill="#666666" stroke="#666666" points="767.31,-166.95 772.46,-157.69 762.66,-161.72 767.31,-166.95"/>
</g>
<!-- GetSessionVars_TxnCtx_GetStmtFutureForRC -->
<g id="node8" class="node">
<title>GetSessionVars_TxnCtx_GetStmtFutureForRC</title>
<path fill="none" stroke="#1c2123" d="M987,-396C987,-396 737,-396 737,-396 731,-396 725,-390 725,-384 725,-384 725,-372 725,-372 725,-366 731,-360 737,-360 737,-360 987,-360 987,-360 993,-360 999,-366 999,-372 999,-372 999,-384 999,-384 999,-390 993,-396 987,-396"/>
<text text-anchor="middle" x="862" y="-374.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">GetSessionVars_TxnCtx_GetStmtFutureForRC</text>
</g>
<!-- refreshForUpdateTSForRC&#45;&gt;GetSessionVars_TxnCtx_GetStmtFutureForRC -->
<g id="edge7" class="edge">
<title>refreshForUpdateTSForRC&#45;&gt;GetSessionVars_TxnCtx_GetStmtFutureForRC</title>
<path fill="none" stroke="#666666" d="M689.09,-378C697.3,-378 705.8,-378 714.43,-378"/>
<polygon fill="#666666" stroke="#666666" points="714.61,-381.5 724.61,-378 714.61,-374.5 714.61,-381.5"/>
</g>
<!-- updateForUpdateTSIfNeeded -->
<g id="node9" class="node">
<title>updateForUpdateTSIfNeeded</title>
<path fill="none" stroke="#1c2123" d="M474,-378C474,-378 322,-378 322,-378 316,-378 310,-372 310,-366 310,-366 310,-354 310,-354 310,-348 316,-342 322,-342 322,-342 474,-342 474,-342 480,-342 486,-348 486,-354 486,-354 486,-366 486,-366 486,-372 480,-378 474,-378"/>
<text text-anchor="middle" x="398" y="-356.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">updateForUpdateTSIfNeeded</text>
</g>
<!-- updateForUpdateTSIfNeeded&#45;&gt;UpdateForUpdateTS -->
<g id="edge8" class="edge">
<title>updateForUpdateTSIfNeeded&#45;&gt;UpdateForUpdateTS</title>
<path fill="none" stroke="#666666" d="M430.03,-341.8C497.23,-302.38 658.63,-207.71 763.71,-146.07"/>
<polygon fill="#666666" stroke="#666666" points="765.58,-149.03 772.44,-140.95 762.04,-142.99 765.58,-149.03"/>
</g>
<!-- updateForUpdateTSIfNeeded&#45;&gt;refreshForUpdateTSForRC -->
<g id="edge9" class="edge">
<title>updateForUpdateTSIfNeeded&#45;&gt;refreshForUpdateTSForRC</title>
<path fill="none" stroke="#666666" d="M486.19,-367.58C495.6,-368.4 505.2,-369.23 514.66,-370.06"/>
<polygon fill="#666666" stroke="#666666" points="514.59,-373.56 524.85,-370.94 515.19,-366.59 514.59,-373.56"/>
</g>
<!-- IsPessimisticReadConsistency -->
<g id="node10" class="node">
<title>IsPessimisticReadConsistency</title>
<path fill="none" stroke="#1c2123" d="M477,-493C477,-493 319,-493 319,-493 313,-493 307,-487 307,-481 307,-481 307,-469 307,-469 307,-463 313,-457 319,-457 319,-457 477,-457 477,-457 483,-457 489,-463 489,-469 489,-469 489,-481 489,-481 489,-487 483,-493 477,-493"/>
<text text-anchor="middle" x="398" y="-471.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">IsPessimisticReadConsistency</text>
</g>
<!-- IsPessimisticReadConsistency&#45;&gt;refreshForUpdateTSForRC -->
<g id="edge10" class="edge">
<title>IsPessimisticReadConsistency&#45;&gt;refreshForUpdateTSForRC</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M437.45,-456.98C471.47,-441.04 521.27,-417.71 557.92,-400.53"/>
<polygon fill="green" stroke="green" points="559.84,-403.5 567.41,-396.09 556.86,-397.16 559.84,-403.5"/>
</g>
<!-- getSnapshotTS -->
<g id="node11" class="node">
<title>getSnapshotTS</title>
<path fill="none" stroke="#1c2123" d="M78,-451C78,-451 209,-451 209,-451 215,-451 221,-457 221,-463 221,-463 221,-515 221,-515 221,-521 215,-527 209,-527 209,-527 78,-527 78,-527 72,-527 66,-521 66,-515 66,-515 66,-463 66,-463 66,-457 72,-451 78,-451"/>
<text text-anchor="middle" x="143.5" y="-511.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">getSnapshotTS</text>
<polyline fill="none" stroke="#1c2123" points="66,-504 221,-504 "/>
<text text-anchor="start" x="74" y="-488.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">returns the timestamp</text>
<text text-anchor="start" x="74" y="-473.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> of the snapshot</text>
<text text-anchor="start" x="74" y="-458.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> that a reader should read</text>
</g>
<!-- getSnapshotTS&#45;&gt;refreshForUpdateTSForRC -->
<g id="edge11" class="edge">
<title>getSnapshotTS&#45;&gt;refreshForUpdateTSForRC</title>
<path fill="none" stroke="#666666" d="M221.31,-469.33C248.37,-462.48 279.01,-454.81 307,-448 377.66,-430.82 457.91,-412.07 517.47,-398.31"/>
<polygon fill="#666666" stroke="#666666" points="518.26,-401.71 527.22,-396.05 516.69,-394.89 518.26,-401.71"/>
</g>
<!-- getSnapshotTS&#45;&gt;IsPessimisticReadConsistency -->
<g id="edge12" class="edge">
<title>getSnapshotTS&#45;&gt;IsPessimisticReadConsistency</title>
<path fill="none" stroke="#666666" d="M221.29,-484.74C245.01,-483.43 271.49,-481.96 296.56,-480.57"/>
<polygon fill="#666666" stroke="#666666" points="297.04,-484.05 306.83,-480 296.65,-477.06 297.04,-484.05"/>
</g>
<!-- buildDelete -->
<g id="node12" class="node">
<title>buildDelete</title>
<path fill="none" stroke="#1c2123" d="M171.5,-432C171.5,-432 115.5,-432 115.5,-432 109.5,-432 103.5,-426 103.5,-420 103.5,-420 103.5,-408 103.5,-408 103.5,-402 109.5,-396 115.5,-396 115.5,-396 171.5,-396 171.5,-396 177.5,-396 183.5,-402 183.5,-408 183.5,-408 183.5,-420 183.5,-420 183.5,-426 177.5,-432 171.5,-432"/>
<text text-anchor="middle" x="143.5" y="-410.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">buildDelete</text>
</g>
<!-- buildDelete&#45;&gt;updateForUpdateTSIfNeeded -->
<g id="edge13" class="edge">
<title>buildDelete&#45;&gt;updateForUpdateTSIfNeeded</title>
<path fill="none" stroke="#666666" d="M183.54,-405.68C208.54,-400.34 241.68,-393.27 271,-387 281.38,-384.78 292.25,-382.45 303.06,-380.14"/>
<polygon fill="#666666" stroke="#666666" points="303.91,-383.54 312.96,-378.02 302.45,-376.69 303.91,-383.54"/>
</g>
<!-- buildUpdate -->
<g id="node13" class="node">
<title>buildUpdate</title>
<path fill="none" stroke="#1c2123" d="M173,-378C173,-378 114,-378 114,-378 108,-378 102,-372 102,-366 102,-366 102,-354 102,-354 102,-348 108,-342 114,-342 114,-342 173,-342 173,-342 179,-342 185,-348 185,-354 185,-354 185,-366 185,-366 185,-372 179,-378 173,-378"/>
<text text-anchor="middle" x="143.5" y="-356.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">buildUpdate</text>
</g>
<!-- buildUpdate&#45;&gt;updateForUpdateTSIfNeeded -->
<g id="edge14" class="edge">
<title>buildUpdate&#45;&gt;updateForUpdateTSIfNeeded</title>
<path fill="none" stroke="#666666" d="M185.07,-360C216.04,-360 260.04,-360 299.93,-360"/>
<polygon fill="#666666" stroke="#666666" points="299.97,-363.5 309.97,-360 299.97,-356.5 299.97,-363.5"/>
</g>
<!-- buildInsert -->
<g id="node14" class="node">
<title>buildInsert</title>
<path fill="none" stroke="#1c2123" d="M28,-217C28,-217 259,-217 259,-217 265,-217 271,-223 271,-229 271,-229 271,-311 271,-311 271,-317 265,-323 259,-323 259,-323 28,-323 28,-323 22,-323 16,-317 16,-311 16,-311 16,-229 16,-229 16,-223 22,-217 28,-217"/>
<text text-anchor="middle" x="143.5" y="-307.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">buildInsert</text>
<polyline fill="none" stroke="#1c2123" points="16,-300 271,-300 "/>
<text text-anchor="start" x="24" y="-284.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">if v.SelectPlan != nil</text>
<text text-anchor="start" x="24" y="-269.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> Try to update the forUpdateTS for</text>
<text text-anchor="start" x="24" y="-254.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> insert/replace into select statements.</text>
<text text-anchor="start" x="24" y="-239.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> Set the selectPlan parameter to nil</text>
<text text-anchor="start" x="24" y="-224.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> to make it always update the forUpdateTS.</text>
</g>
<!-- buildInsert&#45;&gt;updateForUpdateTSIfNeeded -->
<g id="edge15" class="edge">
<title>buildInsert&#45;&gt;updateForUpdateTSIfNeeded</title>
<path fill="none" stroke="#666666" d="M271.12,-315.13C294.07,-323.31 317,-331.48 336.88,-338.57"/>
<polygon fill="#666666" stroke="#666666" points="335.79,-341.9 346.38,-341.96 338.14,-335.3 335.79,-341.9"/>
</g>
</g>
</svg>
