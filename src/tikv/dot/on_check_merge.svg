<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.44.1 (20200629.0846)
 -->
<!-- Title: on_check_merge Pages: 1 -->
<svg width="1799pt" height="392pt"
 viewBox="0.00 0.00 1799.00 392.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 388)">
<title>on_check_merge</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-388 1795,-388 1795,4 -4,4"/>
<!-- on_check_merge -->
<g id="node1" class="node">
<title>on_check_merge</title>
<path fill="none" stroke="#1c2123" d="M527,-284C527,-284 441,-284 441,-284 435,-284 429,-278 429,-272 429,-272 429,-260 429,-260 429,-254 435,-248 441,-248 441,-248 527,-248 527,-248 533,-248 539,-254 539,-260 539,-260 539,-272 539,-272 539,-278 533,-284 527,-284"/>
<text text-anchor="middle" x="484" y="-262.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">on_check_merge</text>
</g>
<!-- register_merge_check_tick -->
<g id="node2" class="node">
<title>register_merge_check_tick</title>
<path fill="none" stroke="#1c2123" d="M799.5,-384C799.5,-384 659.5,-384 659.5,-384 653.5,-384 647.5,-378 647.5,-372 647.5,-372 647.5,-360 647.5,-360 647.5,-354 653.5,-348 659.5,-348 659.5,-348 799.5,-348 799.5,-348 805.5,-348 811.5,-354 811.5,-360 811.5,-360 811.5,-372 811.5,-372 811.5,-378 805.5,-384 799.5,-384"/>
<text text-anchor="middle" x="729.5" y="-362.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">register_merge_check_tick</text>
</g>
<!-- on_check_merge&#45;&gt;register_merge_check_tick -->
<g id="edge1" class="edge">
<title>on_check_merge&#45;&gt;register_merge_check_tick</title>
<path fill="none" stroke="#666666" d="M520.02,-284.09C551.24,-299.81 598.46,-322.57 641,-339 646.01,-340.93 651.21,-342.83 656.48,-344.65"/>
<polygon fill="#666666" stroke="#666666" points="655.4,-347.98 666,-347.87 657.64,-341.35 655.4,-347.98"/>
</g>
<!-- schedule_merge -->
<g id="node3" class="node">
<title>schedule_merge</title>
<path fill="none" stroke="#1c2123" d="M770,-330C770,-330 689,-330 689,-330 683,-330 677,-324 677,-318 677,-318 677,-306 677,-306 677,-300 683,-294 689,-294 689,-294 770,-294 770,-294 776,-294 782,-300 782,-306 782,-306 782,-318 782,-318 782,-324 776,-330 770,-330"/>
<text text-anchor="middle" x="729.5" y="-308.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">schedule_merge</text>
</g>
<!-- on_check_merge&#45;&gt;schedule_merge -->
<g id="edge2" class="edge">
<title>on_check_merge&#45;&gt;schedule_merge</title>
<path fill="none" stroke="#666666" d="M539.04,-276.21C576.81,-283.34 627.32,-292.89 666.68,-300.32"/>
<polygon fill="#666666" stroke="#666666" points="666.22,-303.8 676.7,-302.21 667.52,-296.92 666.22,-303.8"/>
</g>
<!-- pending_merge_state -->
<g id="node4" class="node">
<title>pending_merge_state</title>
<path fill="#feed9b" stroke="#f7e495" d="M866,-123C866,-123 1072,-123 1072,-123 1078,-123 1084,-129 1084,-135 1084,-135 1084,-233 1084,-233 1084,-239 1078,-245 1072,-245 1072,-245 866,-245 866,-245 860,-245 854,-239 854,-233 854,-233 854,-135 854,-135 854,-129 860,-123 866,-123"/>
<text text-anchor="middle" x="969" y="-229.8" font-family="Times,serif" font-size="14.00" fill="#40575d">pending_merge_state</text>
<polyline fill="none" stroke="#f7e495" points="854,-222 1084,-222 "/>
<text text-anchor="start" x="862" y="-206.8" font-family="Times,serif" font-size="14.00" fill="#40575d">Option&lt;MergeState&gt;</text>
<text text-anchor="start" x="862" y="-191.8" font-family="Times,serif" font-size="14.00" fill="#40575d"> pub min_index: u64,</text>
<polyline fill="none" stroke="#f7e495" points="854,-184 1084,-184 "/>
<text text-anchor="start" x="862" y="-168.8" font-family="Times,serif" font-size="14.00" fill="#40575d">pub target: ::protobuf::SingularPtrField</text>
<text text-anchor="start" x="862" y="-153.8" font-family="Times,serif" font-size="14.00" fill="#40575d"> &lt;super::metapb::Region&gt;,</text>
<polyline fill="none" stroke="#f7e495" points="854,-146 1084,-146 "/>
<text text-anchor="start" x="862" y="-130.8" font-family="Times,serif" font-size="14.00" fill="#40575d">pub commit: u64,</text>
</g>
<!-- on_check_merge&#45;&gt;pending_merge_state -->
<g id="edge13" class="edge">
<title>on_check_merge&#45;&gt;pending_merge_state</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M539.14,-268.5C605.7,-270.29 721.67,-269.28 818,-247 826.69,-244.99 835.52,-242.52 844.32,-239.73"/>
<polygon fill="green" stroke="green" points="845.45,-243.04 853.85,-236.58 843.26,-236.39 845.45,-243.04"/>
</g>
<!-- pending_remove -->
<g id="node9" class="node">
<title>pending_remove</title>
<path fill="none" stroke="#1c2123" d="M771.5,-238C771.5,-238 687.5,-238 687.5,-238 681.5,-238 675.5,-232 675.5,-226 675.5,-226 675.5,-214 675.5,-214 675.5,-208 681.5,-202 687.5,-202 687.5,-202 771.5,-202 771.5,-202 777.5,-202 783.5,-208 783.5,-214 783.5,-214 783.5,-226 783.5,-226 783.5,-232 777.5,-238 771.5,-238"/>
<text text-anchor="middle" x="729.5" y="-216.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">pending_remove</text>
</g>
<!-- on_check_merge&#45;&gt;pending_remove -->
<g id="edge14" class="edge">
<title>on_check_merge&#45;&gt;pending_remove</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M539.04,-255.79C576.42,-248.73 626.28,-239.31 665.47,-231.91"/>
<polygon fill="green" stroke="green" points="666.27,-235.32 675.45,-230.02 664.97,-228.44 666.27,-235.32"/>
</g>
<!-- schedule_merge&#45;&gt;pending_merge_state -->
<g id="edge3" class="edge">
<title>schedule_merge&#45;&gt;pending_merge_state</title>
<path fill="none" stroke="#666666" d="M782.18,-295.22C794.16,-290.76 806.69,-285.6 818,-280 828.9,-274.6 847.26,-263.46 867.47,-250.61"/>
<polygon fill="#666666" stroke="#666666" points="869.38,-253.54 875.92,-245.21 865.61,-247.65 869.38,-253.54"/>
</g>
<!-- validate_merge_peer -->
<g id="node5" class="node">
<title>validate_merge_peer</title>
<path fill="none" stroke="#1c2123" d="M1239,-322C1239,-322 1132,-322 1132,-322 1126,-322 1120,-316 1120,-310 1120,-310 1120,-298 1120,-298 1120,-292 1126,-286 1132,-286 1132,-286 1239,-286 1239,-286 1245,-286 1251,-292 1251,-298 1251,-298 1251,-310 1251,-310 1251,-316 1245,-322 1239,-322"/>
<text text-anchor="middle" x="1185.5" y="-300.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">validate_merge_peer</text>
</g>
<!-- schedule_merge&#45;&gt;validate_merge_peer -->
<g id="edge4" class="edge">
<title>schedule_merge&#45;&gt;validate_merge_peer</title>
<path fill="none" stroke="#666666" d="M782.14,-311.09C862.33,-309.68 1017.19,-306.95 1109.65,-305.32"/>
<polygon fill="#666666" stroke="#666666" points="1109.84,-308.82 1119.78,-305.14 1109.71,-301.82 1109.84,-308.82"/>
</g>
<!-- get_min_progress -->
<g id="node6" class="node">
<title>get_min_progress</title>
<path fill="none" stroke="#1c2123" d="M1230.5,-268C1230.5,-268 1140.5,-268 1140.5,-268 1134.5,-268 1128.5,-262 1128.5,-256 1128.5,-256 1128.5,-244 1128.5,-244 1128.5,-238 1134.5,-232 1140.5,-232 1140.5,-232 1230.5,-232 1230.5,-232 1236.5,-232 1242.5,-238 1242.5,-244 1242.5,-244 1242.5,-256 1242.5,-256 1242.5,-262 1236.5,-268 1230.5,-268"/>
<text text-anchor="middle" x="1185.5" y="-246.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">get_min_progress</text>
</g>
<!-- schedule_merge&#45;&gt;get_min_progress -->
<g id="edge5" class="edge">
<title>schedule_merge&#45;&gt;get_min_progress</title>
<path fill="none" stroke="#666666" d="M782.14,-304.95C864.91,-293.64 1027.22,-271.48 1118.36,-259.03"/>
<polygon fill="#666666" stroke="#666666" points="1118.87,-262.5 1128.3,-257.67 1117.92,-255.56 1118.87,-262.5"/>
</g>
<!-- AdminCmdType_CommitMerge -->
<g id="node7" class="node">
<title>AdminCmdType_CommitMerge</title>
<path fill="none" stroke="#1c2123" d="M1473,-341C1473,-341 1299,-341 1299,-341 1293,-341 1287,-335 1287,-329 1287,-329 1287,-317 1287,-317 1287,-311 1293,-305 1299,-305 1299,-305 1473,-305 1473,-305 1479,-305 1485,-311 1485,-317 1485,-317 1485,-329 1485,-329 1485,-335 1479,-341 1473,-341"/>
<text text-anchor="middle" x="1386" y="-319.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">AdminCmdType_CommitMerge</text>
</g>
<!-- schedule_merge&#45;&gt;AdminCmdType_CommitMerge -->
<g id="edge6" class="edge">
<title>schedule_merge&#45;&gt;AdminCmdType_CommitMerge</title>
<path fill="none" stroke="#666666" d="M782.21,-316.16C875.74,-323.17 1079.27,-336.12 1251,-331 1259.37,-330.75 1268.03,-330.41 1276.74,-330.02"/>
<polygon fill="#666666" stroke="#666666" points="1277.14,-333.5 1286.96,-329.53 1276.81,-326.51 1277.14,-333.5"/>
</g>
<!-- router_force_send -->
<g id="node8" class="node">
<title>router_force_send</title>
<path fill="none" stroke="#1c2123" d="M1533,-323C1533,-323 1779,-323 1779,-323 1785,-323 1791,-329 1791,-335 1791,-335 1791,-357 1791,-357 1791,-363 1785,-369 1779,-369 1779,-369 1533,-369 1533,-369 1527,-369 1521,-363 1521,-357 1521,-357 1521,-335 1521,-335 1521,-329 1527,-323 1533,-323"/>
<text text-anchor="middle" x="1656" y="-353.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">router.force_send(targe_id, RaftCommand..)</text>
<polyline fill="none" stroke="#1c2123" points="1521,-346 1791,-346 "/>
<text text-anchor="start" x="1529" y="-330.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">向target发送commit merge的 RaftCommand</text>
</g>
<!-- schedule_merge&#45;&gt;router_force_send -->
<g id="edge7" class="edge">
<title>schedule_merge&#45;&gt;router_force_send</title>
<path fill="none" stroke="#666666" d="M782.07,-326.11C804.06,-331.5 830.11,-337.05 854,-340 1132.36,-374.42 1204.54,-353.3 1485,-350 1493.38,-349.9 1501.99,-349.78 1510.68,-349.63"/>
<polygon fill="#666666" stroke="#666666" points="1510.98,-353.13 1520.91,-349.45 1510.85,-346.13 1510.98,-353.13"/>
</g>
<!-- pending_merge_state&#45;&gt;validate_merge_peer -->
<g id="edge9" class="edge">
<title>pending_merge_state&#45;&gt;validate_merge_peer</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M1063.5,-245.12C1081.93,-256.26 1101.34,-267.39 1120,-277 1123.06,-278.58 1126.23,-280.14 1129.46,-281.66"/>
<polygon fill="green" stroke="green" points="1128.08,-284.88 1138.63,-285.86 1130.99,-278.51 1128.08,-284.88"/>
</g>
<!-- pending_merge_state&#45;&gt;get_min_progress -->
<g id="edge10" class="edge">
<title>pending_merge_state&#45;&gt;get_min_progress</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M1084.16,-219.13C1095.88,-222.73 1107.49,-226.3 1118.42,-229.67"/>
<polygon fill="green" stroke="green" points="1117.67,-233.1 1128.26,-232.7 1119.73,-226.41 1117.67,-233.1"/>
</g>
<!-- validate_merge_peer&#45;&gt;AdminCmdType_CommitMerge -->
<g id="edge11" class="edge">
<title>validate_merge_peer&#45;&gt;AdminCmdType_CommitMerge</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M1251.22,-310.2C1259.43,-310.98 1268.01,-311.8 1276.67,-312.63"/>
<polygon fill="green" stroke="green" points="1276.59,-316.14 1286.88,-313.61 1277.25,-309.17 1276.59,-316.14"/>
</g>
<!-- get_min_progress&#45;&gt;AdminCmdType_CommitMerge -->
<g id="edge12" class="edge">
<title>get_min_progress&#45;&gt;AdminCmdType_CommitMerge</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M1235.57,-268.04C1263,-278.14 1297.39,-290.78 1326.25,-301.39"/>
<polygon fill="green" stroke="green" points="1325.22,-304.74 1335.81,-304.91 1327.63,-298.17 1325.22,-304.74"/>
</g>
<!-- AdminCmdType_CommitMerge&#45;&gt;router_force_send -->
<g id="edge8" class="edge">
<title>AdminCmdType_CommitMerge&#45;&gt;router_force_send</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M1485.27,-331.43C1493.54,-332.14 1502,-332.87 1510.52,-333.6"/>
<polygon fill="green" stroke="green" points="1510.28,-337.09 1520.54,-334.46 1510.88,-330.12 1510.28,-337.09"/>
</g>
<!-- on_ready_prepare_merge -->
<g id="node10" class="node">
<title>on_ready_prepare_merge</title>
<path fill="none" stroke="#1c2123" d="M12,-117C12,-117 315,-117 315,-117 321,-117 327,-123 327,-129 327,-129 327,-219 327,-219 327,-225 321,-231 315,-231 315,-231 12,-231 12,-231 6,-231 0,-225 0,-219 0,-219 0,-129 0,-129 0,-123 6,-117 12,-117"/>
<text text-anchor="middle" x="163.5" y="-215.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">on_ready_prepare_merge</text>
<polyline fill="none" stroke="#1c2123" points="0,-208 327,-208 "/>
<text text-anchor="start" x="8" y="-192.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">设置了pending_state</text>
<text text-anchor="start" x="8" y="-177.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 如果有catch_up_logs</text>
<text text-anchor="start" x="8" y="-162.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 则先让ApplyFsm执行LogsUpToDate</text>
<text text-anchor="start" x="8" y="-147.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 然后在下次merge_check_tick中执行on_check_merge</text>
<polyline fill="none" stroke="#1c2123" points="0,-140 327,-140 "/>
<text text-anchor="start" x="8" y="-124.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">否则就直接执行on_check_merge</text>
</g>
<!-- on_ready_prepare_merge&#45;&gt;on_check_merge -->
<g id="edge18" class="edge">
<title>on_ready_prepare_merge&#45;&gt;on_check_merge</title>
<path fill="none" stroke="#666666" d="M327.02,-220.94C359.8,-230.41 392.39,-239.83 419.25,-247.58"/>
<polygon fill="#666666" stroke="#666666" points="418.29,-250.95 428.87,-250.36 420.23,-244.23 418.29,-250.95"/>
</g>
<!-- on_ready_prepare_merge&#45;&gt;pending_merge_state -->
<g id="edge15" class="edge">
<title>on_ready_prepare_merge&#45;&gt;pending_merge_state</title>
<path fill="none" stroke="#666666" d="M327.1,-176.02C479.76,-177.92 704.87,-180.73 843.66,-182.45"/>
<polygon fill="#666666" stroke="#666666" points="843.87,-185.96 853.91,-182.58 843.96,-178.96 843.87,-185.96"/>
</g>
<!-- on_ready_prepare_merge&#45;&gt;pending_remove -->
<g id="edge16" class="edge">
<title>on_ready_prepare_merge&#45;&gt;pending_remove</title>
<path fill="none" stroke="#666666" d="M327.25,-187.27C440.05,-196.47 584.06,-208.22 665.29,-214.84"/>
<polygon fill="#666666" stroke="#666666" points="665.11,-218.34 675.36,-215.67 665.68,-211.36 665.11,-218.34"/>
</g>
<!-- catch_up_logs -->
<g id="node11" class="node">
<title>catch_up_logs</title>
<path fill="#feed9b" stroke="#f7e495" d="M375,-0.5C375,-0.5 593,-0.5 593,-0.5 599,-0.5 605,-6.5 605,-12.5 605,-12.5 605,-95.5 605,-95.5 605,-101.5 599,-107.5 593,-107.5 593,-107.5 375,-107.5 375,-107.5 369,-107.5 363,-101.5 363,-95.5 363,-95.5 363,-12.5 363,-12.5 363,-6.5 369,-0.5 375,-0.5"/>
<text text-anchor="middle" x="484" y="-92.3" font-family="Times,serif" font-size="14.00" fill="#40575d">catch_up_logs</text>
<polyline fill="none" stroke="#f7e495" points="363,-84.5 605,-84.5 "/>
<text text-anchor="start" x="371" y="-69.3" font-family="Times,serif" font-size="14.00" fill="#40575d">Option&lt;CatchUpLogs&gt;</text>
<text text-anchor="start" x="371" y="-54.3" font-family="Times,serif" font-size="14.00" fill="#40575d"> pub target_region_id: u64,</text>
<polyline fill="none" stroke="#f7e495" points="363,-46.5 605,-46.5 "/>
<text text-anchor="start" x="371" y="-31.3" font-family="Times,serif" font-size="14.00" fill="#40575d">pub merge: CommitMergeRequest,</text>
<polyline fill="none" stroke="#f7e495" points="363,-23.5 605,-23.5 "/>
<text text-anchor="start" x="371" y="-8.3" font-family="Times,serif" font-size="14.00" fill="#40575d">pub logs_up_to_date: Arc&lt;AtomicU64&gt;,</text>
</g>
<!-- on_ready_prepare_merge&#45;&gt;catch_up_logs -->
<g id="edge17" class="edge">
<title>on_ready_prepare_merge&#45;&gt;catch_up_logs</title>
<path fill="none" stroke="#666666" d="M315.82,-116.99C328.36,-112.26 340.96,-107.52 353.31,-102.86"/>
<polygon fill="#666666" stroke="#666666" points="354.58,-106.12 362.7,-99.32 352.11,-99.57 354.58,-106.12"/>
</g>
<!-- schedule_task -->
<g id="node12" class="node">
<title>schedule_task</title>
<path fill="none" stroke="#1c2123" d="M653,-43C653,-43 806,-43 806,-43 812,-43 818,-49 818,-55 818,-55 818,-107 818,-107 818,-113 812,-119 806,-119 806,-119 653,-119 653,-119 647,-119 641,-113 641,-107 641,-107 641,-55 641,-55 641,-49 647,-43 653,-43"/>
<text text-anchor="middle" x="729.5" y="-103.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">schedule_task</text>
<polyline fill="none" stroke="#1c2123" points="641,-96 818,-96 "/>
<text text-anchor="start" x="649" y="-80.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">在source region apply fsm上</text>
<text text-anchor="start" x="649" y="-65.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 执行LogsUpToDate</text>
<text text-anchor="start" x="649" y="-50.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> ApplyTask::LogsUpToDate</text>
</g>
<!-- on_ready_prepare_merge&#45;&gt;schedule_task -->
<g id="edge19" class="edge">
<title>on_ready_prepare_merge&#45;&gt;schedule_task</title>
<path fill="none" stroke="#666666" d="M327.12,-159.04C410.69,-149.82 513.86,-136.06 605,-117 613.5,-115.22 622.26,-113.16 631.02,-110.93"/>
<polygon fill="#666666" stroke="#666666" points="632.09,-114.26 640.88,-108.35 630.32,-107.49 632.09,-114.26"/>
</g>
<!-- catch_up_logs&#45;&gt;schedule_task -->
<g id="edge21" class="edge">
<title>catch_up_logs&#45;&gt;schedule_task</title>
<path fill="none" stroke="#666666" d="M605.32,-67.34C613.84,-68.29 622.37,-69.23 630.74,-70.16"/>
<polygon fill="#666666" stroke="#666666" points="630.53,-73.66 640.86,-71.28 631.31,-66.7 630.53,-73.66"/>
</g>
<!-- on_catch_up_logs_for_merge -->
<g id="node13" class="node">
<title>on_catch_up_logs_for_merge</title>
<path fill="none" stroke="#1c2123" d="M241,-72C241,-72 86,-72 86,-72 80,-72 74,-66 74,-60 74,-60 74,-48 74,-48 74,-42 80,-36 86,-36 86,-36 241,-36 241,-36 247,-36 253,-42 253,-48 253,-48 253,-60 253,-60 253,-66 247,-72 241,-72"/>
<text text-anchor="middle" x="163.5" y="-50.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">on_catch_up_logs_for_merge</text>
</g>
<!-- on_catch_up_logs_for_merge&#45;&gt;catch_up_logs -->
<g id="edge20" class="edge">
<title>on_catch_up_logs_for_merge&#45;&gt;catch_up_logs</title>
<path fill="none" stroke="#666666" d="M253.22,-54C284,-54 319.18,-54 352.6,-54"/>
<polygon fill="#666666" stroke="#666666" points="352.91,-57.5 362.91,-54 352.91,-50.5 352.91,-57.5"/>
</g>
</g>
</svg>
