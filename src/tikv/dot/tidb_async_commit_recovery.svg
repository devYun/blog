<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.47.1 (20210417.1919)
 -->
<!-- Title: async_commit_recovery Pages: 1 -->
<svg width="1471pt" height="274pt"
 viewBox="0.00 0.00 1471.00 274.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 270)">
<title>async_commit_recovery</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-270 1467,-270 1467,4 -4,4"/>
<g id="clust2" class="cluster">
<title>cluster_TiKV</title>
<path fill="none" stroke="slategrey" stroke-dasharray="5,2" d="M628.5,-176C628.5,-176 1443,-176 1443,-176 1449,-176 1455,-182 1455,-188 1455,-188 1455,-246 1455,-246 1455,-252 1449,-258 1443,-258 1443,-258 628.5,-258 628.5,-258 622.5,-258 616.5,-252 616.5,-246 616.5,-246 616.5,-188 616.5,-188 616.5,-182 622.5,-176 628.5,-176"/>
<text text-anchor="middle" x="1035.75" y="-238" font-family="Times,serif" font-size="20.00">TiKV</text>
</g>
<!-- asyncResolveData -->
<g id="node1" class="node">
<title>asyncResolveData</title>
<path fill="none" stroke="#1c2123" d="M858,-68C858,-68 950,-68 950,-68 956,-68 962,-74 962,-80 962,-80 962,-148 962,-148 962,-154 956,-160 950,-160 950,-160 858,-160 858,-160 852,-160 846,-154 846,-148 846,-148 846,-80 846,-80 846,-74 852,-68 858,-68"/>
<text text-anchor="middle" x="904" y="-144.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">asyncResolveData</text>
<polyline fill="none" stroke="#1c2123" points="846,-137 962,-137 "/>
<text text-anchor="start" x="854" y="-121.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">commitTs uint64</text>
<polyline fill="none" stroke="#1c2123" points="846,-114 962,-114 "/>
<text text-anchor="start" x="854" y="-98.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">keys [][]byte</text>
<polyline fill="none" stroke="#1c2123" points="846,-91 962,-91 "/>
<text text-anchor="start" x="854" y="-75.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">missingLock bool</text>
</g>
<!-- GroupKeysByRegion -->
<g id="node4" class="node">
<title>GroupKeysByRegion</title>
<path fill="none" stroke="#1c2123" d="M1120,-97C1120,-97 1010,-97 1010,-97 1004,-97 998,-91 998,-85 998,-85 998,-73 998,-73 998,-67 1004,-61 1010,-61 1010,-61 1120,-61 1120,-61 1126,-61 1132,-67 1132,-73 1132,-73 1132,-85 1132,-85 1132,-91 1126,-97 1120,-97"/>
<text text-anchor="middle" x="1065" y="-75.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">GroupKeysByRegion</text>
</g>
<!-- asyncResolveData&#45;&gt;GroupKeysByRegion -->
<g id="edge9" class="edge">
<title>asyncResolveData&#45;&gt;GroupKeysByRegion</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M962.4,-101.36C970.65,-99.55 979.24,-97.66 987.78,-95.78"/>
<polygon fill="green" stroke="green" points="988.75,-99.15 997.76,-93.58 987.25,-92.31 988.75,-99.15"/>
</g>
<!-- resolveLockAsync -->
<g id="node2" class="node">
<title>resolveLockAsync</title>
<path fill="none" stroke="#1c2123" d="M106,-56C106,-56 12,-56 12,-56 6,-56 0,-50 0,-44 0,-44 0,-32 0,-32 0,-26 6,-20 12,-20 12,-20 106,-20 106,-20 112,-20 118,-26 118,-32 118,-32 118,-44 118,-44 118,-50 112,-56 106,-56"/>
<text text-anchor="middle" x="59" y="-34.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">resolveLockAsync</text>
</g>
<!-- checkAllSecondaries -->
<g id="node3" class="node">
<title>checkAllSecondaries</title>
<path fill="none" stroke="#1c2123" d="M166,-68.5C166,-68.5 410,-68.5 410,-68.5 416,-68.5 422,-74.5 422,-80.5 422,-80.5 422,-147.5 422,-147.5 422,-153.5 416,-159.5 410,-159.5 410,-159.5 166,-159.5 166,-159.5 160,-159.5 154,-153.5 154,-147.5 154,-147.5 154,-80.5 154,-80.5 154,-74.5 160,-68.5 166,-68.5"/>
<text text-anchor="middle" x="288" y="-144.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">1. checkAllSecondaries</text>
<polyline fill="none" stroke="#1c2123" points="154,-136.5 422,-136.5 "/>
<text text-anchor="start" x="162" y="-121.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">检查所有secondaries keys的lock info</text>
<text text-anchor="start" x="162" y="-106.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 先对secondaries keys 根据regio分组</text>
<text text-anchor="start" x="162" y="-91.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 对每个group调用checkSecondaries</text>
<text text-anchor="start" x="162" y="-76.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 然后将key状态添加到asyncResolveData中</text>
</g>
<!-- resolveLockAsync&#45;&gt;checkAllSecondaries -->
<g id="edge1" class="edge">
<title>resolveLockAsync&#45;&gt;checkAllSecondaries</title>
<path fill="none" stroke="#666666" d="M113.8,-56.01C123.23,-59.17 133.44,-62.59 144.01,-66.13"/>
<polygon fill="#666666" stroke="#666666" points="143.22,-69.55 153.81,-69.41 145.44,-62.91 143.22,-69.55"/>
</g>
<!-- resolveLockAsync&#45;&gt;GroupKeysByRegion -->
<g id="edge2" class="edge">
<title>resolveLockAsync&#45;&gt;GroupKeysByRegion</title>
<path fill="none" stroke="#666666" d="M118.34,-38C204.69,-38 371.58,-38 513.5,-38 513.5,-38 513.5,-38 709.5,-38 822.07,-38 850.54,-42.17 962,-58 970.36,-59.19 979.07,-60.64 987.72,-62.22"/>
<polygon fill="#666666" stroke="#666666" points="987.34,-65.71 997.82,-64.13 988.64,-58.84 987.34,-65.71"/>
</g>
<!-- resolveRegionLocks -->
<g id="node5" class="node">
<title>resolveRegionLocks</title>
<path fill="none" stroke="#1c2123" d="M1284,-97C1284,-97 1180,-97 1180,-97 1174,-97 1168,-91 1168,-85 1168,-85 1168,-73 1168,-73 1168,-67 1174,-61 1180,-61 1180,-61 1284,-61 1284,-61 1290,-61 1296,-67 1296,-73 1296,-73 1296,-85 1296,-85 1296,-91 1290,-97 1284,-97"/>
<text text-anchor="middle" x="1232" y="-75.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">resolveRegionLocks</text>
</g>
<!-- resolveLockAsync&#45;&gt;resolveRegionLocks -->
<g id="edge3" class="edge">
<title>resolveLockAsync&#45;&gt;resolveRegionLocks</title>
<path fill="none" stroke="#666666" d="M118.21,-29.99C204.39,-18.84 371.09,0 513.5,0 513.5,0 513.5,0 905,0 1002.91,0 1112.81,-34.07 1176.74,-57.46"/>
<polygon fill="#666666" stroke="#666666" points="1175.62,-60.78 1186.21,-60.97 1178.05,-54.22 1175.62,-60.78"/>
</g>
<!-- checkSecondaries -->
<g id="node6" class="node">
<title>checkSecondaries</title>
<path fill="none" stroke="#1c2123" d="M559,-134C559,-134 470,-134 470,-134 464,-134 458,-128 458,-122 458,-122 458,-110 458,-110 458,-104 464,-98 470,-98 470,-98 559,-98 559,-98 565,-98 571,-104 571,-110 571,-110 571,-122 571,-122 571,-128 565,-134 559,-134"/>
<text text-anchor="middle" x="514.5" y="-112.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">checkSecondaries</text>
</g>
<!-- checkAllSecondaries&#45;&gt;checkSecondaries -->
<g id="edge4" class="edge">
<title>checkAllSecondaries&#45;&gt;checkSecondaries</title>
<path fill="none" stroke="#666666" d="M422.19,-115.19C430.95,-115.26 439.54,-115.34 447.72,-115.41"/>
<polygon fill="#666666" stroke="#666666" points="447.83,-118.92 457.86,-115.5 447.89,-111.92 447.83,-118.92"/>
</g>
<!-- GroupKeysByRegion&#45;&gt;resolveRegionLocks -->
<g id="edge10" class="edge">
<title>GroupKeysByRegion&#45;&gt;resolveRegionLocks</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M1132.16,-79C1140.51,-79 1149.09,-79 1157.55,-79"/>
<polygon fill="green" stroke="green" points="1157.77,-82.5 1167.77,-79 1157.77,-75.5 1157.77,-82.5"/>
</g>
<!-- CmdResolveLock -->
<g id="node8" class="node">
<title>CmdResolveLock</title>
<path fill="none" stroke="#1c2123" d="M1435,-220C1435,-220 1344,-220 1344,-220 1338,-220 1332,-214 1332,-208 1332,-208 1332,-196 1332,-196 1332,-190 1338,-184 1344,-184 1344,-184 1435,-184 1435,-184 1441,-184 1447,-190 1447,-196 1447,-196 1447,-208 1447,-208 1447,-214 1441,-220 1435,-220"/>
<text text-anchor="middle" x="1389.5" y="-198.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">CmdResolveLock</text>
</g>
<!-- resolveRegionLocks&#45;&gt;CmdResolveLock -->
<g id="edge7" class="edge">
<title>resolveRegionLocks&#45;&gt;CmdResolveLock</title>
<path fill="none" stroke="#666666" d="M1255.94,-97.15C1282.9,-118.47 1327.72,-153.92 1357.68,-177.63"/>
<polygon fill="#666666" stroke="#666666" points="1355.7,-180.52 1365.71,-183.98 1360.04,-175.03 1355.7,-180.52"/>
</g>
<!-- addKeys -->
<g id="node7" class="node">
<title>addKeys</title>
<path fill="none" stroke="#1c2123" d="M619,-66.5C619,-66.5 798,-66.5 798,-66.5 804,-66.5 810,-72.5 810,-78.5 810,-78.5 810,-153.5 810,-153.5 810,-159.5 804,-165.5 798,-165.5 798,-165.5 619,-165.5 619,-165.5 613,-165.5 607,-159.5 607,-153.5 607,-153.5 607,-78.5 607,-78.5 607,-72.5 613,-66.5 619,-66.5"/>
<text text-anchor="middle" x="708.5" y="-150.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">2.addKeys</text>
<polyline fill="none" stroke="#1c2123" points="607,-142.5 810,-142.5 "/>
<text text-anchor="start" x="615" y="-127.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">将checkSecondaries 结果加入到</text>
<text text-anchor="start" x="615" y="-112.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> asyncResolveData中</text>
<text text-anchor="start" x="615" y="-97.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 计算事务的min_commit_ts</text>
<polyline fill="none" stroke="#1c2123" points="607,-89.5 810,-89.5 "/>
<text text-anchor="start" x="615" y="-74.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">注意这块对missingLock的处理</text>
</g>
<!-- checkSecondaries&#45;&gt;addKeys -->
<g id="edge5" class="edge">
<title>checkSecondaries&#45;&gt;addKeys</title>
<path fill="none" stroke="#666666" d="M571.03,-116C579.24,-116 587.93,-116 596.79,-116"/>
<polygon fill="#666666" stroke="#666666" points="596.86,-119.5 606.86,-116 596.86,-112.5 596.86,-119.5"/>
</g>
<!-- CmdCheckSecondaryLocks -->
<g id="node9" class="node">
<title>CmdCheckSecondaryLocks</title>
<path fill="none" stroke="#1c2123" d="M780.5,-220C780.5,-220 636.5,-220 636.5,-220 630.5,-220 624.5,-214 624.5,-208 624.5,-208 624.5,-196 624.5,-196 624.5,-190 630.5,-184 636.5,-184 636.5,-184 780.5,-184 780.5,-184 786.5,-184 792.5,-190 792.5,-196 792.5,-196 792.5,-208 792.5,-208 792.5,-214 786.5,-220 780.5,-220"/>
<text text-anchor="middle" x="708.5" y="-198.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">CmdCheckSecondaryLocks</text>
</g>
<!-- checkSecondaries&#45;&gt;CmdCheckSecondaryLocks -->
<g id="edge8" class="edge">
<title>checkSecondaries&#45;&gt;CmdCheckSecondaryLocks</title>
<path fill="none" stroke="#666666" d="M539.18,-134.2C557,-147.15 582.47,-164.11 607,-175 611.41,-176.96 616,-178.8 620.67,-180.53"/>
<polygon fill="#666666" stroke="#666666" points="619.77,-183.93 630.37,-183.93 622.09,-177.32 619.77,-183.93"/>
</g>
<!-- addKeys&#45;&gt;asyncResolveData -->
<g id="edge6" class="edge">
<title>addKeys&#45;&gt;asyncResolveData</title>
<path fill="none" stroke="#666666" d="M810.22,-114.96C818.8,-114.87 827.35,-114.78 835.58,-114.7"/>
<polygon fill="#666666" stroke="#666666" points="835.86,-118.19 845.82,-114.59 835.79,-111.19 835.86,-118.19"/>
</g>
<!-- resolveLock -->
<g id="node10" class="node">
<title>resolveLock</title>
<path fill="none" stroke="#1c2123" d="M24,-75C24,-75 94,-75 94,-75 100,-75 106,-81 106,-87 106,-87 106,-109 106,-109 106,-115 100,-121 94,-121 94,-121 24,-121 24,-121 18,-121 12,-115 12,-109 12,-109 12,-87 12,-87 12,-81 18,-75 24,-75"/>
<text text-anchor="middle" x="59" y="-105.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">3.resolveLock</text>
<polyline fill="none" stroke="#1c2123" points="12,-98 106,-98 "/>
<text text-anchor="middle" x="59" y="-82.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> </text>
</g>
</g>
</svg>
