<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.47.1 (20210417.1919)
 -->
<!-- Title: pessimistic_rollback Pages: 1 -->
<svg width="1549pt" height="265pt"
 viewBox="0.00 0.00 1549.00 265.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 261)">
<title>pessimistic_rollback</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-261 1545,-261 1545,4 -4,4"/>
<!-- SimpleExec_executeRollback -->
<g id="node1" class="node">
<title>SimpleExec_executeRollback</title>
<path fill="none" stroke="#1c2123" d="M12,-159.5C12,-159.5 168,-159.5 168,-159.5 174,-159.5 180,-165.5 180,-171.5 180,-171.5 180,-193.5 180,-193.5 180,-199.5 174,-205.5 168,-205.5 168,-205.5 12,-205.5 12,-205.5 6,-205.5 0,-199.5 0,-193.5 0,-193.5 0,-171.5 0,-171.5 0,-165.5 6,-159.5 12,-159.5"/>
<text text-anchor="middle" x="90" y="-190.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">SimpleExec::executeRollback</text>
<polyline fill="none" stroke="#1c2123" points="0,-182.5 180,-182.5 "/>
<text text-anchor="start" x="8" y="-167.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">执行Rollback语句</text>
</g>
<!-- KVTxn_Rollback -->
<g id="node2" class="node">
<title>KVTxn_Rollback</title>
<path fill="none" stroke="#1c2123" d="M228,-159.5C228,-159.5 318,-159.5 318,-159.5 324,-159.5 330,-165.5 330,-171.5 330,-171.5 330,-193.5 330,-193.5 330,-199.5 324,-205.5 318,-205.5 318,-205.5 228,-205.5 228,-205.5 222,-205.5 216,-199.5 216,-193.5 216,-193.5 216,-171.5 216,-171.5 216,-165.5 222,-159.5 228,-159.5"/>
<text text-anchor="start" x="224" y="-190.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">KVTxn::Rollback</text>
<polyline fill="none" stroke="#1c2123" points="216,-182.5 330,-182.5 "/>
<text text-anchor="start" x="224" y="-167.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">回滚事务</text>
</g>
<!-- SimpleExec_executeRollback&#45;&gt;KVTxn_Rollback -->
<g id="edge1" class="edge">
<title>SimpleExec_executeRollback&#45;&gt;KVTxn_Rollback</title>
<path fill="none" stroke="#666666" d="M180.17,-182.5C188.8,-182.5 197.45,-182.5 205.79,-182.5"/>
<polygon fill="#666666" stroke="#666666" points="205.8,-186 215.8,-182.5 205.8,-179 205.8,-186"/>
</g>
<!-- KVTxn_rollbackPessimisticLocks -->
<g id="node3" class="node">
<title>KVTxn_rollbackPessimisticLocks</title>
<path fill="none" stroke="#1c2123" d="M378,-159.5C378,-159.5 558,-159.5 558,-159.5 564,-159.5 570,-165.5 570,-171.5 570,-171.5 570,-193.5 570,-193.5 570,-199.5 564,-205.5 558,-205.5 558,-205.5 378,-205.5 378,-205.5 372,-205.5 366,-199.5 366,-193.5 366,-193.5 366,-171.5 366,-171.5 366,-165.5 372,-159.5 378,-159.5"/>
<text text-anchor="start" x="374" y="-190.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">KVTxn::rollbackPessimisticLocks</text>
<polyline fill="none" stroke="#1c2123" points="366,-182.5 570,-182.5 "/>
<text text-anchor="start" x="374" y="-167.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">释放掉获取的悲观锁</text>
</g>
<!-- KVTxn_Rollback&#45;&gt;KVTxn_rollbackPessimisticLocks -->
<g id="edge2" class="edge">
<title>KVTxn_Rollback&#45;&gt;KVTxn_rollbackPessimisticLocks</title>
<path fill="none" stroke="#666666" d="M330.08,-182.5C338.16,-182.5 346.7,-182.5 355.41,-182.5"/>
<polygon fill="#666666" stroke="#666666" points="355.7,-186 365.7,-182.5 355.7,-179 355.7,-186"/>
</g>
<!-- KVTxn_collectLockedKeys -->
<g id="node4" class="node">
<title>KVTxn_collectLockedKeys</title>
<path fill="none" stroke="#1c2123" d="M618,-105.5C618,-105.5 774,-105.5 774,-105.5 780,-105.5 786,-111.5 786,-117.5 786,-117.5 786,-177.5 786,-177.5 786,-183.5 780,-189.5 774,-189.5 774,-189.5 618,-189.5 618,-189.5 612,-189.5 606,-183.5 606,-177.5 606,-177.5 606,-117.5 606,-117.5 606,-111.5 612,-105.5 618,-105.5"/>
<text text-anchor="middle" x="696" y="-174.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">KVTxn::collectLockedKeys</text>
<polyline fill="none" stroke="#1c2123" points="606,-166.5 786,-166.5 "/>
<text text-anchor="start" x="614" y="-151.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">收集Locked keys</text>
<polyline fill="none" stroke="#1c2123" points="606,-143.5 786,-143.5 "/>
<text text-anchor="start" x="614" y="-128.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">1.遍历MemBuffer</text>
<text text-anchor="start" x="614" y="-113.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 检查key flags 为locked keys</text>
</g>
<!-- KVTxn_rollbackPessimisticLocks&#45;&gt;KVTxn_collectLockedKeys -->
<g id="edge3" class="edge">
<title>KVTxn_rollbackPessimisticLocks&#45;&gt;KVTxn_collectLockedKeys</title>
<path fill="none" stroke="#666666" d="M570.1,-166.84C578.63,-165.52 587.26,-164.19 595.77,-162.87"/>
<polygon fill="#666666" stroke="#666666" points="596.37,-166.32 605.71,-161.33 595.29,-159.4 596.37,-166.32"/>
</g>
<!-- txn_committer_pessimisticRollbackMutations -->
<g id="node5" class="node">
<title>txn_committer_pessimisticRollbackMutations</title>
<path fill="none" stroke="#1c2123" d="M834,-195.5C834,-195.5 992,-195.5 992,-195.5 998,-195.5 1004,-201.5 1004,-207.5 1004,-207.5 1004,-229.5 1004,-229.5 1004,-235.5 998,-241.5 992,-241.5 992,-241.5 834,-241.5 834,-241.5 828,-241.5 822,-235.5 822,-229.5 822,-229.5 822,-207.5 822,-207.5 822,-201.5 828,-195.5 834,-195.5"/>
<text text-anchor="start" x="830" y="-226.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">twoPhaseCommitter</text>
<polyline fill="none" stroke="#1c2123" points="822,-218.5 1004,-218.5 "/>
<text text-anchor="start" x="830" y="-203.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">pessimisticRollbackMutations</text>
</g>
<!-- KVTxn_rollbackPessimisticLocks&#45;&gt;txn_committer_pessimisticRollbackMutations -->
<g id="edge4" class="edge">
<title>KVTxn_rollbackPessimisticLocks&#45;&gt;txn_committer_pessimisticRollbackMutations</title>
<path fill="none" stroke="#666666" d="M570.31,-194.92C582.33,-196.22 594.43,-197.45 606,-198.5 674.54,-204.74 751.89,-209.78 811.67,-213.24"/>
<polygon fill="#666666" stroke="#666666" points="811.68,-216.74 821.86,-213.82 812.08,-209.75 811.68,-216.74"/>
</g>
<!-- KVTxn_collectLockedKeys&#45;&gt;txn_committer_pessimisticRollbackMutations -->
<g id="edge8" class="edge">
<title>KVTxn_collectLockedKeys&#45;&gt;txn_committer_pessimisticRollbackMutations</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M786,-176.89C801.35,-181.96 817.22,-187.2 832.31,-192.18"/>
<polygon fill="green" stroke="green" points="831.5,-195.6 842.1,-195.42 833.7,-188.96 831.5,-195.6"/>
</g>
<!-- txn_GetMemBuffer -->
<g id="node6" class="node">
<title>txn_GetMemBuffer</title>
<path fill="none" stroke="#1c2123" d="M844.5,-130.5C844.5,-130.5 981.5,-130.5 981.5,-130.5 987.5,-130.5 993.5,-136.5 993.5,-142.5 993.5,-142.5 993.5,-164.5 993.5,-164.5 993.5,-170.5 987.5,-176.5 981.5,-176.5 981.5,-176.5 844.5,-176.5 844.5,-176.5 838.5,-176.5 832.5,-170.5 832.5,-164.5 832.5,-164.5 832.5,-142.5 832.5,-142.5 832.5,-136.5 838.5,-130.5 844.5,-130.5"/>
<text text-anchor="middle" x="913" y="-161.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">1.KVTxn::GetMemBuffer</text>
<polyline fill="none" stroke="#1c2123" points="832.5,-153.5 993.5,-153.5 "/>
<text text-anchor="start" x="840.5" y="-138.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">获取事务的MemBuffer</text>
</g>
<!-- KVTxn_collectLockedKeys&#45;&gt;txn_GetMemBuffer -->
<g id="edge5" class="edge">
<title>KVTxn_collectLockedKeys&#45;&gt;txn_GetMemBuffer</title>
<path fill="none" stroke="#666666" d="M786,-149.98C798,-150.32 810.33,-150.66 822.34,-151"/>
<polygon fill="#666666" stroke="#666666" points="822.25,-154.5 832.35,-151.28 822.45,-147.5 822.25,-154.5"/>
</g>
<!-- IterWithFlags -->
<g id="node7" class="node">
<title>IterWithFlags</title>
<path fill="none" stroke="#1c2123" d="M846,-65.5C846,-65.5 980,-65.5 980,-65.5 986,-65.5 992,-71.5 992,-77.5 992,-77.5 992,-99.5 992,-99.5 992,-105.5 986,-111.5 980,-111.5 980,-111.5 846,-111.5 846,-111.5 840,-111.5 834,-105.5 834,-99.5 834,-99.5 834,-77.5 834,-77.5 834,-71.5 840,-65.5 846,-65.5"/>
<text text-anchor="middle" x="913" y="-96.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">2.MemDB::IterWithFlags</text>
<polyline fill="none" stroke="#1c2123" points="834,-88.5 992,-88.5 "/>
<text text-anchor="start" x="842" y="-73.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">遍历事务的MemBuffer</text>
</g>
<!-- KVTxn_collectLockedKeys&#45;&gt;IterWithFlags -->
<g id="edge6" class="edge">
<title>KVTxn_collectLockedKeys&#45;&gt;IterWithFlags</title>
<path fill="none" stroke="#666666" d="M786,-123.08C798.49,-119.65 811.32,-116.13 823.79,-112.71"/>
<polygon fill="#666666" stroke="#666666" points="824.99,-116.01 833.71,-109.99 823.14,-109.26 824.99,-116.01"/>
</g>
<!-- HasLocked -->
<g id="node8" class="node">
<title>HasLocked</title>
<path fill="none" stroke="#1c2123" d="M836.5,-0.5C836.5,-0.5 989.5,-0.5 989.5,-0.5 995.5,-0.5 1001.5,-6.5 1001.5,-12.5 1001.5,-12.5 1001.5,-34.5 1001.5,-34.5 1001.5,-40.5 995.5,-46.5 989.5,-46.5 989.5,-46.5 836.5,-46.5 836.5,-46.5 830.5,-46.5 824.5,-40.5 824.5,-34.5 824.5,-34.5 824.5,-12.5 824.5,-12.5 824.5,-6.5 830.5,-0.5 836.5,-0.5"/>
<text text-anchor="middle" x="913" y="-31.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">3.KeyFlags::HasLocked</text>
<polyline fill="none" stroke="#1c2123" points="824.5,-23.5 1001.5,-23.5 "/>
<text text-anchor="start" x="832.5" y="-8.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">检查key是否有Locked flags</text>
</g>
<!-- KVTxn_collectLockedKeys&#45;&gt;HasLocked -->
<g id="edge7" class="edge">
<title>KVTxn_collectLockedKeys&#45;&gt;HasLocked</title>
<path fill="none" stroke="#666666" d="M747.05,-105.42C769.06,-88.34 795.82,-69.4 822,-55.5 825.1,-53.86 828.3,-52.27 831.56,-50.73"/>
<polygon fill="#666666" stroke="#666666" points="833.19,-53.83 840.89,-46.55 830.34,-47.44 833.19,-53.83"/>
</g>
<!-- doActionOnMutations -->
<g id="node9" class="node">
<title>doActionOnMutations</title>
<path fill="none" stroke="#1c2123" d="M1052,-180.5C1052,-180.5 1263,-180.5 1263,-180.5 1269,-180.5 1275,-186.5 1275,-192.5 1275,-192.5 1275,-244.5 1275,-244.5 1275,-250.5 1269,-256.5 1263,-256.5 1263,-256.5 1052,-256.5 1052,-256.5 1046,-256.5 1040,-250.5 1040,-244.5 1040,-244.5 1040,-192.5 1040,-192.5 1040,-186.5 1046,-180.5 1052,-180.5"/>
<text text-anchor="middle" x="1157.5" y="-241.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">doActionOnMutations</text>
<polyline fill="none" stroke="#1c2123" points="1040,-233.5 1275,-233.5 "/>
<text text-anchor="start" x="1048" y="-218.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">对mutations分组，分批</text>
<text text-anchor="start" x="1048" y="-203.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 并发的调用actionPessimisticRollback</text>
<text text-anchor="start" x="1048" y="-188.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> handleSignleBatch</text>
</g>
<!-- txn_committer_pessimisticRollbackMutations&#45;&gt;doActionOnMutations -->
<g id="edge9" class="edge">
<title>txn_committer_pessimisticRollbackMutations&#45;&gt;doActionOnMutations</title>
<path fill="none" stroke="#666666" d="M1004.3,-218.5C1012.62,-218.5 1021.15,-218.5 1029.72,-218.5"/>
<polygon fill="#666666" stroke="#666666" points="1029.79,-222 1039.79,-218.5 1029.79,-215 1029.79,-222"/>
</g>
<!-- actionPessimisticRollback_handleSingleBatch -->
<g id="node10" class="node">
<title>actionPessimisticRollback_handleSingleBatch</title>
<path fill="none" stroke="#1c2123" d="M1323,-184C1323,-184 1529,-184 1529,-184 1535,-184 1541,-190 1541,-196 1541,-196 1541,-241 1541,-241 1541,-247 1535,-253 1529,-253 1529,-253 1323,-253 1323,-253 1317,-253 1311,-247 1311,-241 1311,-241 1311,-196 1311,-196 1311,-190 1317,-184 1323,-184"/>
<text text-anchor="start" x="1319" y="-237.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">actionPessimisticRollback</text>
<polyline fill="none" stroke="#1c2123" points="1311,-230 1541,-230 "/>
<text text-anchor="start" x="1319" y="-214.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">handleSingleBatch</text>
<polyline fill="none" stroke="#1c2123" points="1311,-207 1541,-207 "/>
<text text-anchor="middle" x="1426" y="-191.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">发送PessimisticRollback请求给TiKV</text>
</g>
<!-- doActionOnMutations&#45;&gt;actionPessimisticRollback_handleSingleBatch -->
<g id="edge10" class="edge">
<title>doActionOnMutations&#45;&gt;actionPessimisticRollback_handleSingleBatch</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M1275,-218.5C1283.56,-218.5 1292.21,-218.5 1300.81,-218.5"/>
<polygon fill="green" stroke="green" points="1300.87,-222 1310.87,-218.5 1300.87,-215 1300.87,-222"/>
</g>
</g>
</svg>
